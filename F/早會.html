<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰</title>
  <style>
    :root{
      --bg:#eef1f4;
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --shadow2: 0 3px 10px rgba(0,0,0,0.06);
      --green:#16a34a;
      --red:#dc2626;
      --blue:#0891b2;
      --dark:#111827;
      --chip:#f3f4f6;
      --chipOn:#e7f1ff;
      --chipBorder:#3b82f6;

      /* âœ… æ–°å¢ï¼šå°æ¨™ç±¤é¡è‰² */
      --amber:#f59e0b;     /* å»¶æœŸ */
      --ghost:#e5e7eb;     /* æ¨ç®— */
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Microsoft JhengHei", system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--text);
      background:var(--bg);
      padding: max(12px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Top Controls (mobile first) ===== */
    .controls{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow2);
      border-radius: 14px;
      padding: 12px;
      margin: 0 auto 12px auto;
      max-width: 1100px;
    }

    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title h1{
      margin:0;
      font-size: 18px; /* mobile */
      letter-spacing: .2px;
    }
    .updated{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }

    /* ===== Scrollable date chips ===== */
    .dayStrip{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 2px;
      align-items:center;
      max-width: 100%;
    }
    .dayStrip::-webkit-scrollbar{ display:none; }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 2px solid transparent;
      user-select:none;
      cursor:pointer;
      font-weight: 700;
      font-size: 14px;
      line-height: 1;
      touch-action: manipulation;
      flex: 0 0 auto;
      scroll-snap-align: start;
      white-space: nowrap;
    }
    .chip input{ transform: scale(1.25); }
    .chip.on{
      background: var(--chipOn);
      border-color: var(--chipBorder);
      color: #0b3a82;
    }
    .chip .sub{
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
      margin-left: 2px;
    }

    .searchBox{
      flex: 1 1 220px;
      display:flex;
      gap:8px;
      min-width: 220px;
    }
    .searchBox input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .btn{
      border:0;
      background: var(--dark);
      color:#fff;
      padding: 11px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .stats{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:left;
    }

    /* ===== Dashboard ===== */
    #app{ max-width: 1100px; margin: 0 auto; }
    .loading{
      text-align:center;
      color: var(--muted);
      padding: 40px 0;
      font-size: 16px;
      font-weight: 700;
    }
    .err{
      text-align:center;
      color: #b00020;
      padding: 18px;
      font-weight: 900;
      background: #fff;
      border: 1px solid #ffd2d6;
      border-radius: 14px;
      box-shadow: var(--shadow2);
    }

    /* Mobile-first: single column */
    .dashboard{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* Desktop enhancements */
    @media (min-width: 820px){
      body{ padding: 18px 18px 22px; }
      .title h1{ font-size: 22px; }
      .dashboard{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1120px){
      .dashboard{ grid-template-columns: 1fr 1fr 1fr; }
    }

    /* ===== Person Card (accordion) ===== */
    details.card{
      background: var(--card);
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    summary.cardHead{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 6px solid #6c757d;
    }
    summary.cardHead::-webkit-details-marker{ display:none; }

    .personName{
      font-size: 16px;
      font-weight: 900;
    }
    .personMeta{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }
    .badge{
      background: #111827;
      color: #fff;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }

    .tasks{
      padding: 10px 12px 12px;
      border-top: 1px solid var(--line);
    }

    .task{
      border: 1px solid var(--line);
      border-left: 6px solid #c7c7c7;
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
      margin-bottom: 10px;
    }
    .task:last-child{ margin-bottom:0; }

    .task.is-today{ border-left-color: var(--green); background:#ecfdf3; }
    .task.is-overdue{ border-left-color: var(--red); background:#fff5f5; }
    .task.is-tomorrow{ border-left-color: var(--blue); background:#e6fbff; }

    .taskTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      font-weight: 900;
    }
    .taskName{ font-size: 15px; }

    /* âœ… å³ä¸Šè§’å¯æ”¾å¤šå€‹æ¨™ç±¤ï¼ˆæ—¥æœŸ / å»¶æœŸ / æ¨ç®—ï¼‰ */
    .tagWrap{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 52%;
    }

    .tag{
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      color:#fff;
      white-space:nowrap;
    }

    .tagMini{
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .tagDelay{ background: var(--amber); color:#111827; }
    .tagInferred{ background: var(--ghost); color:#111827; }

    .detail{
      margin-top: 6px;
      font-size: 13px;
      line-height: 1.45;
      color: #374151;
    }
    .muted{ color: var(--muted); font-weight: 700; }

    /* small helper */
    .sep{ height:10px; }
  </style>
</head>
<body>

  <div class="controls">
    <div class="title">
      <h1>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï½œ7å¤©æ»¾å‹•ï¼‰</h1>
      <div class="updated" id="updatedAt">â€”</div>
    </div>

    <div class="row">
      <div class="dayStrip" id="dayStrip"></div>

      <div class="searchBox">
        <input id="q" placeholder="æœå°‹ï¼šå®¢å / äº‹é … / åœ°å€ï¼ˆè¼¸å…¥å°±æœƒç¯©ï¼‰" />
        <button class="btn" id="btnReload">é‡è¼‰</button>
      </div>
    </div>

    <div class="stats" id="stats"></div>
  </div>

  <div id="app" class="loading">è³‡æ–™è®€å–ä¸­...</div>

<script>
  const CONFIG = {
    apiKey: "UGQ4cGFmNjg2R0J2TXNSMXpZdVVvSlhIUVRLZHo2SmpISXUyMFQrRCtySXFDTUk2T2NCeUY4b0FDcXJ6OENqRA==",
    baseUrl: "https://ap12.ragic.com/89793238/fami/2",
    fields: {
      status: "1000111",
      date:   "1000122",
      person: "1000113",
      reason: "1000120",
      addr:   "1000119",
      name:   "1000116"
    }
  };

  const PENDING_STATUSES = ["å¾…è™•ç†", "æœªå®Œæˆ", "å»¶æœŸ"];

  const WEEKDAY = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const RANGE_DAYS = 7;

  const startOfDay = (d) => {
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  };

  const toStr = (d) =>
    d.getFullYear() + "/" +
    String(d.getMonth()+1).padStart(2,"0") + "/" +
    String(d.getDate()).padStart(2,"0");

  const RANGE_START = startOfDay(new Date());
  const RANGE_DATES = Array.from({length:RANGE_DAYS}, (_,i)=>{
    const d = new Date(RANGE_START);
    d.setDate(d.getDate() + i);
    return d;
  });
  const RANGE_STR = RANGE_DATES.map(toStr);
  const TODAY_STR = RANGE_STR[0];
  const TOMORROW_STR = RANGE_STR[1] || "";

  let ALL_RECORDS = [];
  let IS_LOADING = false;

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "__ragic_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
      s.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

      function cleanup(){
        try { delete window[cb]; } catch(e){ window[cb] = undefined; }
        s.remove();
      }
      document.head.appendChild(s);
    });
  }

  function getValue(r, id){
    const v = r?.[id];
    if (v == null) return "";
    if (typeof v === "object") return (v.value ?? v._index_title_ ?? v.name ?? "").toString();
    return v.toString();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setLoading(flag){
    IS_LOADING = flag;
    document.getElementById("btnReload").disabled = flag;
  }

  function syncChips(){
    document.querySelectorAll(".chip").forEach(chip=>{
      const input = chip.querySelector('input[type="checkbox"]');
      if (!input) return;
      chip.classList.toggle("on", input.checked);
    });
  }

  function setUpdatedNow(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    document.getElementById("updatedAt").innerText = `æ›´æ–° ${hh}:${mm}`;
  }

  // =============================
  // âœ… è£œé‡˜ï¼šæŠŠä»»ä½•ä¾†æºçš„æ—¥æœŸæ­£è¦åŒ–æˆ YYYY/MM/DD
  // =============================
  function normalizeDate10(raw){
    const s = String(raw ?? "").trim();
    if (!s) return "";
    // æ”¯æ´ 2025/12/30 æˆ– 2025-12-30 æˆ– "2025/12/30 10:20"
    const m = s.match(/(20\d{2})[\/\-](\d{2})[\/\-](\d{2})/);
    if (m) return `${m[1]}/${m[2]}/${m[3]}`;
    // æ”¯æ´ 20251230
    const m2 = s.match(/\b(20\d{2})(\d{2})(\d{2})\b/);
    if (m2) return `${m2[1]}/${m2[2]}/${m2[3]}`;
    return "";
  }

  // =============================
  // âœ… è£œé‡˜ï¼šç”¨å–®è™Ÿ(EID)æ¨ç®—æ—¥æœŸï¼ˆå„ªå…ˆç”¨ã€Œå·²å»ºæ—¥æœŸã€ï¼‰
  // å–®è™Ÿéœ€åŒ…å«ï¼šYYYYMMDD æˆ– YYYY/MM/DD æˆ– YYYY-MM-DD
  // =============================
  function inferDateFromEid(eid){
    const s = String(eid ?? "").trim();
    if (!s) return "";
    const m = s.match(/(20\d{2})[\/\-]?(\d{2})[\/\-]?(\d{2})/); // 20251230 / 2025-12-30 / 2025/12/30
    if (!m) return "";
    return `${m[1]}/${m[2]}/${m[3]}`;
  }

  // =============================
  // âœ… å»ºç«‹ chips
  // =============================
  function buildDayChips(){
    const wrap = document.getElementById("dayStrip");
    let html = `
      <label class="chip on" id="chipOverdue">
        <input type="checkbox" id="chkOverdue" checked />
        éæœŸ
      </label>
    `;

    RANGE_DATES.forEach((d, i)=>{
      const ds = RANGE_STR[i];
      const wd = WEEKDAY[d.getDay()];
      const isToday = i === 0;
      const isTomorrow = i === 1;
      const checked = isToday || isTomorrow;

      const label =
        isToday ? "ä»Šå¤©" :
        isTomorrow ? "æ˜å¤©" :
        `é€±${wd}`;

      html += `
        <label class="chip ${checked ? "on" : ""}" id="chipD${i}">
          <input type="checkbox" id="chkD${i}" ${checked ? "checked" : ""} />
          ${label}
          <span class="sub">${ds.slice(5)}</span>
        </label>
      `;
    });

    wrap.innerHTML = html;
    syncChips();
  }

  // =============================
  // è¼‰å…¥è³‡æ–™ï¼ˆåªæŠ“å¾…è¾¦ç‹€æ…‹ï¼‰
  // =============================
  async function loadFromRagic(){
    if (!CONFIG.apiKey || CONFIG.apiKey.includes("__PUT")){
      document.getElementById("app").innerHTML =
        `<div class="err">è«‹å…ˆåœ¨ CONFIG.apiKey å¡«å…¥ã€Œæ–°ç”Ÿæˆã€çš„ API Keyï¼ˆä½ è²¼éçš„é‚£æŠŠè«‹ä½œå»¢é‡ç”Ÿï¼‰</div>`;
      return;
    }

    try{
      setLoading(true);
      document.getElementById("app").innerHTML = `<div class="loading">è³‡æ–™è®€å–ä¸­...</div>`;

      const params = new URLSearchParams();
      params.set("api","");
      params.set("APIKey", CONFIG.apiKey);
      params.set("naming","EID");
      params.set("limit","1000");
      params.set("reverse","true");

      for (const st of PENDING_STATUSES){
        params.append("where", `${CONFIG.fields.status},eq,${st}`);
      }

      const url = `${CONFIG.baseUrl}?${params.toString()}`;
      const data = await jsonp(url);

      // âœ… é—œéµï¼šä¿ç•™ EIDï¼ˆå› ç‚ºç„¡æ—¥æœŸè¦é å®ƒæ¨ç®—ï¼‰
      ALL_RECORDS = Object.entries(data || {})
        .filter(([eid, v]) => v && typeof v === "object" && v._ragicId !== 0)
        .map(([eid, v]) => {
          const rawDate = getValue(v, CONFIG.fields.date);
          const d10_from_field = normalizeDate10(rawDate);
          const d10_from_eid   = inferDateFromEid(eid);

          v.__eid = eid;
          v.__date10 = d10_from_field || d10_from_eid || "";
          v.__dateSource = d10_from_field ? "field" : (d10_from_eid ? "eid" : "");

          return v;
        });

      setUpdatedNow();
      render();
    }catch(err){
      console.error(err);
      document.getElementById("app").innerHTML =
        `<div class="err">è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ baseUrl(ap12)ã€APIKey æ¬Šé™ã€æˆ–ç‹€æ…‹å­—ä¸²æ˜¯å¦å®Œå…¨ä¸€è‡´</div>`;
    }finally{
      setLoading(false);
    }
  }

  // =============================
  // âœ… æ¸²æŸ“ï¼ˆ7å¤©æ»¾å‹•ï¼‰
  // =============================
  function render(){
    syncChips();

    const query = (document.getElementById("q").value || "").trim().toLowerCase();
    const showOverdue = document.getElementById("chkOverdue")?.checked ?? true;

    const selectedDates = [];
    for (let i=0; i<RANGE_DAYS; i++){
      const chk = document.getElementById(`chkD${i}`);
      if (chk?.checked) selectedDates.push(RANGE_STR[i]);
    }

    const filtered = ALL_RECORDS.filter(r => {
      const status = getValue(r, CONFIG.fields.status);
      if (status === "å·²å®Œæˆ" || status === "å–æ¶ˆ") return false;

      // âœ… æ”¹ç”¨ã€Œè£œé‡˜å¾Œçš„æ—¥æœŸã€
      const d = r.__date10 || "";
      if (!d) return false; // é€£ EID éƒ½æ¨ä¸å‡ºä¾†å°±å…ˆä¸é¡¯ç¤ºï¼ˆé¿å…äº‚å…¥ï¼‰

      const inRange =
        (d < TODAY_STR && showOverdue) ||
        (selectedDates.includes(d));

      if (!inRange) return false;

      if (!query) return true;

      const name = getValue(r, CONFIG.fields.name);
      const task = getValue(r, CONFIG.fields.reason);
      const addr = getValue(r, CONFIG.fields.addr);
      const person = getValue(r, CONFIG.fields.person);
      const eid = r.__eid || "";
      const hay = `${name} ${task} ${addr} ${person} ${eid}`.toLowerCase();
      return hay.includes(query);
    });

    const rangeHint = `${RANGE_STR[0]} ~ ${RANGE_STR[RANGE_STR.length-1]}`;
    const inferredCount = ALL_RECORDS.filter(r => r.__dateSource === "eid").length;
    const missingCount = ALL_RECORDS.filter(r => !r.__date10).length;

    document.getElementById("stats").innerText =
      `é¡¯ç¤º ${filtered.length}ï½œå¾…è¾¦ç¸½æ•¸ ${ALL_RECORDS.length}ï½œ7å¤©ç¯„åœ ${rangeHint}ï½œç„¡æ—¥æœŸ(ç”¨å–®è™Ÿæ¨ç®—) ${inferredCount}ï½œä»ç„¡æ³•æ¨ç®— ${missingCount}`;

    if (filtered.length === 0){
      document.getElementById("app").innerHTML =
        `<div class="loading">æ­¤ç¯„åœæ²’æœ‰å¾…è¾¦</div>`;
      return;
    }

    const grouped = filtered.reduce((acc, r) => {
      const p = getValue(r, CONFIG.fields.person) || "å¾…æŒ‡æ´¾";
      (acc[p] ||= []).push(r);
      return acc;
    }, {});

    const isMobile = window.matchMedia("(max-width: 640px)").matches;

    const score = (d) => {
      if (d < TODAY_STR) return 0;
      const idx = RANGE_STR.indexOf(d);
      if (idx >= 0) return idx + 1;
      return 999;
    };

    let html = `<div class="dashboard">`;

    for (const person of Object.keys(grouped).sort((a,b)=>a.localeCompare(b,"zh-Hant"))){
      const tasks = grouped[person];

      tasks.sort((a,b)=>{
        const da = a.__date10 || "";
        const db = b.__date10 || "";
        const sa = score(da), sb = score(db);
        if (sa !== sb) return sa - sb;
        return da.localeCompare(db);
      });

      const hasOverdue = tasks.some(t => (t.__date10 || "") < TODAY_STR);
      const openAttr = (!isMobile || hasOverdue) ? "open" : "";

      let topColor = "#6c757d";
      if (hasOverdue) topColor = "#dc2626";
      else if (tasks.some(t => (t.__date10 || "") === TODAY_STR)) topColor = "#16a34a";
      else if (TOMORROW_STR && tasks.some(t => (t.__date10 || "") === TOMORROW_STR)) topColor = "#0891b2";

      html += `
        <details class="card" ${openAttr}>
          <summary class="cardHead" style="border-top-color:${topColor}">
            <div class="personName">${escapeHtml(person)}</div>
            <div class="personMeta">
              <span class="badge">${tasks.length}</span>
              <span class="muted">${hasOverdue ? "æœ‰éæœŸ" : ""}</span>
            </div>
          </summary>
          <div class="tasks">
      `;

      html += tasks.map(t=>{
        const d = t.__date10 || "";
        const status = getValue(t, CONFIG.fields.status);
        const name = getValue(t, CONFIG.fields.name) || "(æœªå¡«å®¢å)";
        const task = getValue(t, CONFIG.fields.reason) || "(æœªå¡«äº‹é …)";
        const addr = getValue(t, CONFIG.fields.addr) || "(æœªå¡«åœ°å€)";
        const inferred = (t.__dateSource === "eid");

        let cls = "";
        let tagText = d;
        let tagColor = "#6b7280";

        const isOverdue = d < TODAY_STR;

        if (isOverdue){
          cls = "is-overdue"; tagText = `éæœŸ ${d}`; tagColor = "#dc2626";
        } else if (d === TODAY_STR){
          cls = "is-today"; tagText = "ä»Šå¤©"; tagColor = "#16a34a";
        } else if (TOMORROW_STR && d === TOMORROW_STR){
          cls = "is-tomorrow"; tagText = "æ˜å¤©"; tagColor = "#0891b2";
        } else {
          const idx = RANGE_STR.indexOf(d);
          if (idx >= 0){
            const wd = WEEKDAY[RANGE_DATES[idx].getDay()];
            tagText = `é€±${wd} ${d.slice(5)}`;
          }
        }

        // âœ… åŠŸèƒ½ 2ï¼šéæœŸä¸”æ¨™å»¶æœŸ â†’ é¡¯ç¤ºã€å»¶æœŸã€‘æ¨™ç±¤
        const showDelayBadge = isOverdue && status === "å»¶æœŸ";

        return `
          <div class="task ${cls}">
            <div class="taskTop">
              <div class="taskName">${escapeHtml(name)}</div>
              <div class="tagWrap">
                <div class="tag" style="background:${tagColor}">${escapeHtml(tagText)}</div>
                ${showDelayBadge ? `<div class="tagMini tagDelay">å»¶æœŸ</div>` : ``}
                ${inferred ? `<div class="tagMini tagInferred">å–®è™Ÿæ¨ç®—</div>` : ``}
              </div>
            </div>
            <div class="detail">
              <div><b>${escapeHtml(task)}</b></div>
              <div class="muted">ğŸ“ ${escapeHtml(addr)}</div>
            </div>
          </div>
        `;
      }).join("");

      html += `</div></details>`;
    }

    html += `</div>`;
    document.getElementById("app").innerHTML = html;
  }

  function init(){
    buildDayChips();

    document.getElementById("dayStrip").addEventListener("change", (e)=>{
      if (e.target && e.target.matches('input[type="checkbox"]')) render();
    });

    document.getElementById("q").addEventListener("input", render);
    document.getElementById("btnReload").addEventListener("click", loadFromRagic);

    loadFromRagic();
  }

  init();
</script>
</body>
</html>
