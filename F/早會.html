<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰</title>
  <style>
    :root{
      --bg:#eef1f4;
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --shadow2: 0 3px 10px rgba(0,0,0,0.06);
      --green:#16a34a;
      --red:#dc2626;
      --blue:#0891b2;
      --dark:#111827;
      --chip:#f3f4f6;
      --chipOn:#e7f1ff;
      --chipBorder:#3b82f6;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Microsoft JhengHei", system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--text);
      background:var(--bg);
      padding: max(12px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Top Controls (mobile first) ===== */
    .controls{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow2);
      border-radius: 14px;
      padding: 12px;
      margin: 0 auto 12px auto;
      max-width: 1100px;
    }

    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title h1{
      margin:0;
      font-size: 18px; /* mobile */
      letter-spacing: .2px;
    }
    .updated{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 2px solid transparent;
      user-select:none;
      cursor:pointer;
      font-weight: 700;
      font-size: 14px;
      line-height: 1;
      touch-action: manipulation;
    }
    .chip input{ transform: scale(1.25); }
    .chip.on{
      background: var(--chipOn);
      border-color: var(--chipBorder);
      color: #0b3a82;
    }

    .searchBox{
      flex: 1 1 220px;
      display:flex;
      gap:8px;
      min-width: 220px;
    }
    .searchBox input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .btn{
      border:0;
      background: var(--dark);
      color:#fff;
      padding: 11px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .stats{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:left;
    }

    /* ===== Dashboard ===== */
    #app{ max-width: 1100px; margin: 0 auto; }
    .loading{
      text-align:center;
      color: var(--muted);
      padding: 40px 0;
      font-size: 16px;
      font-weight: 700;
    }
    .err{
      text-align:center;
      color: #b00020;
      padding: 18px;
      font-weight: 900;
      background: #fff;
      border: 1px solid #ffd2d6;
      border-radius: 14px;
      box-shadow: var(--shadow2);
    }

    /* Mobile-first: single column */
    .dashboard{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* Desktop enhancements */
    @media (min-width: 820px){
      body{ padding: 18px 18px 22px; }
      .title h1{ font-size: 22px; }
      .dashboard{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1120px){
      .dashboard{ grid-template-columns: 1fr 1fr 1fr; }
    }

    /* ===== Person Card (accordion) ===== */
    details.card{
      background: var(--card);
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    summary.cardHead{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 6px solid #6c757d;
    }
    summary.cardHead::-webkit-details-marker{ display:none; }

    .personName{
      font-size: 16px;
      font-weight: 900;
    }
    .personMeta{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }
    .badge{
      background: #111827;
      color: #fff;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }

    .tasks{
      padding: 10px 12px 12px;
      border-top: 1px solid var(--line);
    }

    .task{
      border: 1px solid var(--line);
      border-left: 6px solid #c7c7c7;
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
      margin-bottom: 10px;
    }
    .task:last-child{ margin-bottom:0; }

    .task.is-today{ border-left-color: var(--green); background:#ecfdf3; }
    .task.is-overdue{ border-left-color: var(--red); background:#fff5f5; }
    .task.is-tomorrow{ border-left-color: var(--blue); background:#e6fbff; }

    .taskTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      font-weight: 900;
    }
    .taskName{ font-size: 15px; }
    .tag{
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      color:#fff;
      white-space:nowrap;
    }
    .detail{
      margin-top: 6px;
      font-size: 13px;
      line-height: 1.45;
      color: #374151;
    }
    .muted{ color: var(--muted); font-weight: 700; }

    /* small helper */
    .sep{ height:10px; }
  </style>
</head>
<body>

  <div class="controls">
    <div class="title">
      <h1>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰</h1>
      <div class="updated" id="updatedAt">â€”</div>
    </div>

    <div class="row">
      <div class="chips">
        <label class="chip" id="chipYesterday">
          <input type="checkbox" id="chkYesterday" checked />
          æ˜¨å¤©ä»¥å‰
        </label>
        <label class="chip" id="chipToday">
          <input type="checkbox" id="chkToday" checked />
          ä»Šå¤©
        </label>
        <label class="chip" id="chipTomorrow">
          <input type="checkbox" id="chkTomorrow" />
          æ˜å¤©
        </label>
      </div>

      <div class="searchBox">
        <input id="q" placeholder="æœå°‹ï¼šå®¢å / äº‹é … / åœ°å€ï¼ˆè¼¸å…¥å°±æœƒç¯©ï¼‰" />
        <button class="btn" id="btnReload">é‡è¼‰</button>
      </div>
    </div>

    <div class="stats" id="stats"></div>
  </div>

  <div id="app" class="loading">è³‡æ–™è®€å–ä¸­...</div>

<script>
  // =============================
  // åªæ”¹é€™ä¸‰æ®µ
  // =============================
  const CONFIG = {
    apiKey: "UGQ4cGFmNjg2R0J2TXNSMXpZdVVvSlhIUVRLZHo2SmpISXUyMFQrRCtySXFDTUk2T2NCeUY4b0FDcXJ6OENqRA==", // â† è«‹å¡«ã€Œæ–°ç”Ÿæˆã€çš„ keyï¼ˆä½ è²¼éçš„é‚£æŠŠè«‹ä½œå»¢ï¼‰
    baseUrl: "https://ap12.ragic.com/89793238/fami/2",
    fields: {
      status: "1000111",
      date:   "1000122",
      person: "1000113",
      reason: "1000120",
      addr:   "1000119",
      name:   "1000116"
    }
  };

  // ä½ è¦è¦–ç‚ºå¾…è¾¦çš„ç‹€æ…‹ç™½åå–®ï¼ˆå­—è¦è·Ÿ Ragic å®Œå…¨ä¸€è‡´ï¼‰
  const PENDING_STATUSES = ["å¾…è™•ç†", "æœªå®Œæˆ", "å»¶æœŸ"];

  // =============================
  // æ—¥æœŸå·¥å…·
  // =============================
  const today = new Date();
  const yest = new Date(today); yest.setDate(today.getDate() - 1);
  const tmrw = new Date(today); tmrw.setDate(today.getDate() + 1);

  const toStr = (d) =>
    d.getFullYear() + "/" +
    String(d.getMonth()+1).padStart(2,"0") + "/" +
    String(d.getDate()).padStart(2,"0");

  const DATE_MAP = {
    today: toStr(today),
    yesterday: toStr(yest),
    tomorrow: toStr(tmrw)
  };

  let ALL_RECORDS = [];
  let IS_LOADING = false;

  // =============================
  // JSONPï¼ˆè·¨åŸŸç©©ï¼‰
  // =============================
  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "__ragic_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
      s.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

      function cleanup(){
        try { delete window[cb]; } catch(e){ window[cb] = undefined; }
        s.remove();
      }
      document.head.appendChild(s);
    });
  }

  function getValue(r, id){
    const v = r?.[id];
    if (v == null) return "";
    if (typeof v === "object") return (v.value ?? v._index_title_ ?? v.name ?? "").toString();
    return v.toString();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setLoading(flag){
    IS_LOADING = flag;
    document.getElementById("btnReload").disabled = flag;
  }

  function syncChips(){
    const map = [
      ["chkYesterday","chipYesterday"],
      ["chkToday","chipToday"],
      ["chkTomorrow","chipTomorrow"],
    ];
    for (const [chk, chip] of map){
      const on = document.getElementById(chk).checked;
      document.getElementById(chip).classList.toggle("on", on);
    }
  }

  function setUpdatedNow(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    document.getElementById("updatedAt").innerText = `æ›´æ–° ${hh}:${mm}`;
  }

  // =============================
  // è¼‰å…¥è³‡æ–™ï¼ˆåªæŠ“å¾…è¾¦ç‹€æ…‹ï¼‰
  // =============================
  async function loadFromRagic(){
    if (!CONFIG.apiKey || CONFIG.apiKey.includes("__PUT")){
      document.getElementById("app").innerHTML =
        `<div class="err">è«‹å…ˆåœ¨ CONFIG.apiKey å¡«å…¥ã€Œæ–°ç”Ÿæˆã€çš„ API Keyï¼ˆä½ è²¼éçš„é‚£æŠŠè«‹ä½œå»¢é‡ç”Ÿï¼‰</div>`;
      return;
    }

    try{
      setLoading(true);
      document.getElementById("app").innerHTML = `<div class="loading">è³‡æ–™è®€å–ä¸­...</div>`;

      const params = new URLSearchParams();
      params.set("api","");
      params.set("APIKey", CONFIG.apiKey);
      params.set("naming","EID");
      params.set("limit","1000");
      params.set("reverse","true");

      // ORï¼šåŒæ¬„ä½å¤šå€‹ eqï¼ˆç™½åå–®ç‹€æ…‹ï¼‰
      for (const st of PENDING_STATUSES){
        params.append("where", `${CONFIG.fields.status},eq,${st}`);
      }

      const url = `${CONFIG.baseUrl}?${params.toString()}`;
      const data = await jsonp(url);

      ALL_RECORDS = Object.values(data || {})
        .filter(v => v && typeof v === "object" && v._ragicId !== 0);

      setUpdatedNow();
      render();
    }catch(err){
      console.error(err);
      document.getElementById("app").innerHTML =
        `<div class="err">è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ baseUrl(ap12)ã€APIKey æ¬Šé™ã€æˆ–ç‹€æ…‹å­—ä¸²æ˜¯å¦å®Œå…¨ä¸€è‡´</div>`;
    }finally{
      setLoading(false);
    }
  }

  // =============================
  // æ¸²æŸ“ï¼ˆæ‰‹æ©Ÿå„ªå…ˆ + å¯æ”¶åˆï¼‰
  // =============================
  function render(){
    syncChips();

    const showY  = document.getElementById("chkYesterday").checked;
    const showT  = document.getElementById("chkToday").checked;
    const showTm = document.getElementById("chkTomorrow").checked;

    const query = (document.getElementById("q").value || "").trim().toLowerCase();

    const filtered = ALL_RECORDS.filter(r => {
      // é˜²å‘†ï¼šæ’é™¤å®Œæˆ/å–æ¶ˆï¼ˆå³ä½¿ä½ ç™½åå–®æ²’åˆ—åˆ°ä¹Ÿä¸æœƒè·‘å‡ºä¾†ï¼‰
      const status = getValue(r, CONFIG.fields.status);
      if (status === "å·²å®Œæˆ" || status === "å–æ¶ˆ") return false;

      const rawDate = getValue(r, CONFIG.fields.date);
      if (!rawDate) return false;
      const d = rawDate.substring(0,10);

      const inDateRange =
        (d < DATE_MAP.today && showY) ||
        (d === DATE_MAP.today && showT) ||
        (d === DATE_MAP.tomorrow && showTm);

      if (!inDateRange) return false;

      if (!query) return true;

      const name = getValue(r, CONFIG.fields.name);
      const task = getValue(r, CONFIG.fields.reason);
      const addr = getValue(r, CONFIG.fields.addr);
      const person = getValue(r, CONFIG.fields.person);
      const hay = `${name} ${task} ${addr} ${person}`.toLowerCase();
      return hay.includes(query);
    });

    document.getElementById("stats").innerText =
      `é¡¯ç¤º ${filtered.length}ï½œå¾…è¾¦ç¸½æ•¸ ${ALL_RECORDS.length}ï½œä»Šå¤© ${DATE_MAP.today}ï½œæ˜å¤© ${DATE_MAP.tomorrow}`;

    if (filtered.length === 0){
      document.getElementById("app").innerHTML =
        `<div class="loading">æ­¤ç¯„åœæ²’æœ‰å¾…è¾¦</div>`;
      return;
    }

    const grouped = filtered.reduce((acc, r) => {
      const p = getValue(r, CONFIG.fields.person) || "å¾…æŒ‡æ´¾";
      (acc[p] ||= []).push(r);
      return acc;
    }, {});

    const isMobile = window.matchMedia("(max-width: 640px)").matches;

    // æ’åºç”¨ï¼šéæœŸ(0) â†’ ä»Šå¤©(1) â†’ æ˜å¤©(2) â†’ å…¶ä»–(3)
    const score = (d) => {
      if (d < DATE_MAP.today) return 0;
      if (d === DATE_MAP.today) return 1;
      if (d === DATE_MAP.tomorrow) return 2;
      return 3;
    };

    let html = `<div class="dashboard">`;

    for (const person of Object.keys(grouped).sort((a,b)=>a.localeCompare(b,"zh-Hant"))){
      const tasks = grouped[person];

      tasks.sort((a,b)=>{
        const da = getValue(a, CONFIG.fields.date).substring(0,10);
        const db = getValue(b, CONFIG.fields.date).substring(0,10);
        const sa = score(da), sb = score(db);
        if (sa !== sb) return sa - sb;
        return da.localeCompare(db);
      });

      // æ‰‹æ©Ÿé è¨­ï¼šåªæœ‰ã€Œæœ‰éæœŸã€çš„äººå±•é–‹ï¼›é›»è…¦é è¨­å…¨å±•é–‹
      const hasOverdue = tasks.some(t => getValue(t, CONFIG.fields.date).substring(0,10) < DATE_MAP.today);
      const openAttr = (!isMobile || hasOverdue) ? "open" : "";

      // ä¾æ•´çµ„çš„æƒ…æ³ä¸Šè‰²ï¼ˆç´”è¦–è¦ºï¼‰
      let topColor = "#6c757d";
      if (hasOverdue) topColor = "#dc2626";
      else if (tasks.some(t => getValue(t, CONFIG.fields.date).substring(0,10) === DATE_MAP.today)) topColor = "#16a34a";
      else if (tasks.some(t => getValue(t, CONFIG.fields.date).substring(0,10) === DATE_MAP.tomorrow)) topColor = "#0891b2";

      html += `
        <details class="card" ${openAttr}>
          <summary class="cardHead" style="border-top-color:${topColor}">
            <div class="personName">${escapeHtml(person)}</div>
            <div class="personMeta">
              <span class="badge">${tasks.length}</span>
              <span class="muted">${hasOverdue ? "æœ‰éæœŸ" : ""}</span>
            </div>
          </summary>
          <div class="tasks">
      `;

      html += tasks.map(t=>{
        const d = getValue(t, CONFIG.fields.date).substring(0,10);
        const name = getValue(t, CONFIG.fields.name) || "(æœªå¡«å®¢å)";
        const task = getValue(t, CONFIG.fields.reason) || "(æœªå¡«äº‹é …)";
        const addr = getValue(t, CONFIG.fields.addr) || "(æœªå¡«åœ°å€)";

        let cls = "";
        let tagText = d;
        let tagColor = "#6b7280";

        if (d < DATE_MAP.today){
          cls = "is-overdue"; tagText = `éæœŸ ${d}`; tagColor = "#dc2626";
        } else if (d === DATE_MAP.today){
          cls = "is-today"; tagText = "ä»Šå¤©"; tagColor = "#16a34a";
        } else if (d === DATE_MAP.tomorrow){
          cls = "is-tomorrow"; tagText = "æ˜å¤©"; tagColor = "#0891b2";
        }

        return `
          <div class="task ${cls}">
            <div class="taskTop">
              <div class="taskName">${escapeHtml(name)}</div>
              <div class="tag" style="background:${tagColor}">${escapeHtml(tagText)}</div>
            </div>
            <div class="detail">
              <div><b>${escapeHtml(task)}</b></div>
              <div class="muted">ğŸ“ ${escapeHtml(addr)}</div>
            </div>
          </div>
        `;
      }).join("");

      html += `</div></details>`;
    }

    html += `</div>`;
    document.getElementById("app").innerHTML = html;
  }

  // =============================
  // Init
  // =============================
  function init(){
    ["chkYesterday","chkToday","chkTomorrow"].forEach(id=>{
      document.getElementById(id).addEventListener("change", render);
    });

    document.getElementById("q").addEventListener("input", render);

    document.getElementById("btnReload").addEventListener("click", loadFromRagic);

    syncChips();
    loadFromRagic();
  }

  init();
</script>
</body>
</html>
