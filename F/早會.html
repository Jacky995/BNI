<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ - èª¿åº¦ä¸­å¿ƒ</title>
  <style>
    body { font-family: "Microsoft JhengHei", system-ui, sans-serif; background: #e9ecef; padding: 20px; margin: 0; }

    /* é ‚éƒ¨æ§åˆ¶å€ */
    .controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .filter-group { display: flex; justify-content: center; gap: 16px; align-items: center; flex-wrap: wrap; }

    .chk-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 1.05em;
      padding: 8px 14px;
      border-radius: 20px;
      transition: all 0.2s;
      border: 2px solid transparent;
      background: #f8f9fa;
      user-select: none;
    }
    .chk-label input { margin-right: 8px; transform: scale(1.2); }

    /* å…¼å®¹ï¼šä¸é  :hasï¼Œæ”¹ç”± JS è¿½åŠ  .is-checked */
    .chk-label.is-checked { background: #e7f1ff; border-color: #007bff; color: #0056b3; font-weight: 700; }

    /* çœ‹æ¿å€ */
    .dashboard { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 14px;
      width: 340px;
      border-top: 6px solid #6c757d;
      display: flex;
      flex-direction: column;
    }
    .card h2 {
      margin: 0 0 10px 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.25em;
    }
    .badge {
      font-size: 0.75em;
      background: #eee;
      padding: 2px 10px;
      border-radius: 999px;
      color: #333;
      font-weight: 700;
    }

    .task-item {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      border-left: 6px solid #ccc;
    }
    /* ç‹€æ…‹é¡è‰² */
    .task-item.is-today { border-left-color: #28a745; background: #e8f5e9; }     /* ä»Šå¤©: ç¶  */
    .task-item.is-overdue { border-left-color: #dc3545; background: #fff5f5; }  /* éæœŸ: ç´… */
    .task-item.is-tomorrow { border-left-color: #17a2b8; background: #e0f7fa; } /* æ˜å¤©: è— */

    .task-header { font-weight: 800; font-size: 1.05em; color: #333; display: flex; justify-content: space-between; gap: 10px; align-items: flex-start; }
    .task-detail { margin-top: 6px; font-size: 0.95em; color: #555; line-height: 1.45; }
    .tag { padding: 2px 8px; border-radius: 6px; color: white; font-weight: 800; font-size: 0.75em; white-space: nowrap; }

    .loading { font-size: 1.3em; text-align: center; color: #555; margin-top: 50px; }
    .err { color: #b00020; text-align: center; font-weight: 700; }
    .hint { color: #666; font-size: 0.9em; }
    button {
      border: 0;
      background: #111;
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>
<body>

  <div class="controls">
    <h2 style="margin:0 0 10px 0;">å…¨å®¶ç¦æ—©æœƒçœ‹æ¿</h2>

    <div class="filter-group">
      <label class="chk-label" id="lblYesterday">
        <input type="checkbox" id="chkYesterday" checked>
        æ˜¨å¤©ä»¥å‰ (è¿½é€²åº¦)
      </label>
      <label class="chk-label" id="lblToday">
        <input type="checkbox" id="chkToday" checked>
        ä»Šå¤© (è¡åˆº)
      </label>
      <label class="chk-label" id="lblTomorrow">
        <input type="checkbox" id="chkTomorrow">
        æ˜å¤© (é å‚™)
      </label>

      <button id="btnReload" title="é‡æ–°æŠ“ä¸€æ¬¡ Ragic">é‡æ–°è¼‰å…¥</button>
    </div>

    <div id="stats" class="hint" style="margin-top:10px;"></div>
  </div>

  <div id="app" class="loading">è³‡æ–™è®€å–ä¸­...</div>

  <script>
    // =============================
    // 1) ä½ åªè¦æ”¹é€™è£¡
    // =============================
    const CONFIG = {
      apiKey: "UGQ4cGFmNjg2R0J2TXNSMXpZdVVvSlhIUVRLZHo2SmpISXUyMFQrRCtySXFDTUk2T2NCeUY4b0FDcXJ6OENqRA==",     // â† è«‹å¡«ã€Œæ–°ç”Ÿæˆã€çš„ API Keyï¼ˆä½ å‰›è²¼çš„é‚£æŠŠè«‹ä½œå»¢ï¼‰
      baseUrl: "https://ap12.ragic.com/89793238/fami/2", // â† ä½ çš„ sheet API baseï¼ˆçœ‹èµ·ä¾†æ˜¯å°çš„ï¼‰
      fields: {
        status: "1000111",
        date:   "1000122",
        person: "1000113",
        reason: "1000120",
        addr:   "1000119",
        name:   "1000116"
      }
    };

    // ä½ è¦è¦–ç‚ºã€Œå¾…è¾¦ã€çš„ç‹€æ…‹ï¼ˆç”¨ç™½åå–®æœ€ç©©ï¼Œé¿å…ç”¨ neï¼‰
    const PENDING_STATUSES = ["å¾…è™•ç†", "æœªå®Œæˆ", "å»¶æœŸ"];

    // =============================
    // 2) æ—¥æœŸè¨ˆç®—
    // =============================
    const today = new Date();
    const yest = new Date(today); yest.setDate(today.getDate() - 1);
    const tmrw = new Date(today); tmrw.setDate(today.getDate() + 1);

    const toStr = (d) =>
      d.getFullYear() + "/" +
      String(d.getMonth() + 1).padStart(2, "0") + "/" +
      String(d.getDate()).padStart(2, "0");

    const DATE_MAP = {
      today: toStr(today),
      yesterday: toStr(yest),
      tomorrow: toStr(tmrw)
    };

    let ALL_RECORDS = [];
    let IS_LOADING = false;

    // =============================
    // 3) JSONPï¼ˆè·¨åŸŸæœ€ç©©ï¼‰
    // =============================
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = "__ragic_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        window[cb] = (data) => { cleanup(); resolve(data); };

        const s = document.createElement("script");
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
        s.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

        function cleanup() {
          try { delete window[cb]; } catch (e) { window[cb] = undefined; }
          s.remove();
        }

        document.head.appendChild(s);
      });
    }

    // =============================
    // 4) å–å€¼å·¥å…·ï¼ˆRagic æ¬„ä½æœ‰æ™‚æ˜¯ objectï¼‰
    // =============================
    function getValue(r, id) {
      const v = r?.[id];
      if (v == null) return "";
      if (typeof v === "object") {
        return (v.value ?? v._index_title_ ?? v.name ?? "").toString();
      }
      return v.toString();
    }

    function setLoading(flag) {
      IS_LOADING = flag;
      document.getElementById("btnReload").disabled = flag;
    }

    // æ§åˆ¶åˆ— label é«˜äº®ï¼ˆä¸ä¾è³´ :hasï¼‰
    function syncCheckStyle() {
      const map = [
        ["chkYesterday", "lblYesterday"],
        ["chkToday", "lblToday"],
        ["chkTomorrow", "lblTomorrow"],
      ];
      for (const [chkId, lblId] of map) {
        const checked = document.getElementById(chkId).checked;
        document.getElementById(lblId).classList.toggle("is-checked", checked);
      }
    }

    // =============================
    // 5) æŠ“è³‡æ–™ï¼ˆåªæŠ“ã€Œå¾…è¾¦ç‹€æ…‹ç™½åå–®ã€ï¼‰
    // =============================
    async function loadFromRagic() {
      if (!CONFIG.apiKey || CONFIG.apiKey.includes("__PUT")) {
        document.getElementById("app").innerHTML =
          `<div class="err">è«‹å…ˆåœ¨ CONFIG.apiKey å¡«å…¥æ–°çš„ API Keyï¼ˆä½ å‰›è²¼é‚£æŠŠè«‹ä½œå»¢é‡ç”Ÿï¼‰</div>`;
        return;
      }

      try {
        setLoading(true);
        document.getElementById("app").innerHTML = `<div class="loading">è³‡æ–™è®€å–ä¸­...</div>`;

        const params = new URLSearchParams();
        params.set("api", "");
        params.set("APIKey", CONFIG.apiKey);
        params.set("naming", "EID");
        params.set("limit", "1000");
        params.set("reverse", "true");

        // åŒæ¬„ä½å¤šå€‹ eq â†’ ORï¼ˆä¸€æ¬¡æ’ˆå¤šç¨®å¾…è¾¦ç‹€æ…‹ï¼‰
        for (const st of PENDING_STATUSES) {
          params.append("where", `${CONFIG.fields.status},eq,${st}`);
        }

        const url = `${CONFIG.baseUrl}?${params.toString()}`;
        const data = await jsonp(url);

        // data æœƒæ˜¯ç‰©ä»¶ï¼ˆkey=recordIdï¼‰ï¼Œè½‰é™£åˆ—ï¼Œä¸¦éæ¿¾æ‰é record
        ALL_RECORDS = Object.values(data || {})
          .filter(v => v && typeof v === "object")
          .filter(v => v._ragicId !== 0);

        render(ALL_RECORDS);
      } catch (err) {
        console.error(err);
        document.getElementById("app").innerHTML =
          `<div class="err">è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ baseUrl æ˜¯å¦æ­£ç¢ºï¼ˆap12ï¼‰ã€APIKey æ¬Šé™ã€æˆ–ç‹€æ…‹å­—ä¸²æ˜¯å¦å®Œå…¨ä¸€è‡´</div>`;
      } finally {
        setLoading(false);
      }
    }

    // =============================
    // 6) æ¸²æŸ“ï¼ˆæ—¥æœŸå€é–“å‹¾é¸ï¼‰
    // =============================
    function render(records) {
      syncCheckStyle();

      const showY = document.getElementById("chkYesterday").checked;
      const showT = document.getElementById("chkToday").checked;
      const showTm = document.getElementById("chkTomorrow").checked;

      // å‰ç«¯å†åšä¿éšªï¼šæ’é™¤ã€Œå·²å®Œæˆ/å–æ¶ˆã€
      const filtered = records.filter(r => {
        const status = getValue(r, CONFIG.fields.status);
        if (status === "å·²å®Œæˆ" || status === "å–æ¶ˆ") return false;

        const rawDate = getValue(r, CONFIG.fields.date);
        if (!rawDate) return false;

        const d = rawDate.substring(0, 10); // YYYY/MM/DD
        if (d === DATE_MAP.today && showT) return true;
        if (d === DATE_MAP.tomorrow && showTm) return true;
        if (d < DATE_MAP.today && showY) return true;
        return false;
      });

      // çµ±è¨ˆ
      document.getElementById("stats").innerText =
        `é¡¯ç¤ºç­†æ•¸: ${filtered.length}ï¼ˆç¸½å¾…è¾¦: ${records.length}ï¼‰ï½œä»Šå¤©: ${DATE_MAP.today}ï½œæ˜å¤©: ${DATE_MAP.tomorrow}`;

      if (filtered.length === 0) {
        document.getElementById("app").innerHTML =
          `<h3 style="width:100%; text-align:center; color:#888;">æ­¤ç¯„åœç„¡å¾…è¾¦äº‹é …</h3>`;
        return;
      }

      // åˆ†çµ„ï¼ˆäººå“¡ï¼‰
      const grouped = filtered.reduce((acc, curr) => {
        const person = getValue(curr, CONFIG.fields.person) || "å¾…æŒ‡æ´¾";
        (acc[person] ||= []).push(curr);
        return acc;
      }, {});

      // æ¯å€‹äººè£¡é¢æŒ‰æ—¥æœŸæ’åºï¼ˆéæœŸâ†’ä»Šå¤©â†’æ˜å¤©ï¼‰
      const dateScore = (dStr) => {
        if (dStr < DATE_MAP.today) return 0;
        if (dStr === DATE_MAP.today) return 1;
        if (dStr === DATE_MAP.tomorrow) return 2;
        return 3;
      };

      let html = `<div class="dashboard">`;

      for (const person of Object.keys(grouped).sort((a,b)=>a.localeCompare(b,"zh-Hant"))) {
        const tasks = grouped[person];

        tasks.sort((a, b) => {
          const da = getValue(a, CONFIG.fields.date).substring(0, 10);
          const db = getValue(b, CONFIG.fields.date).substring(0, 10);
          const sa = dateScore(da), sb = dateScore(db);
          if (sa !== sb) return sa - sb;
          return da.localeCompare(db);
        });

        html += `<div class="card">
          <h2>
            <span>${escapeHtml(person)}</span>
            <span class="badge">${tasks.length}</span>
          </h2>`;

        html += tasks.map(t => {
          const d = getValue(t, CONFIG.fields.date).substring(0, 10);
          const task = getValue(t, CONFIG.fields.reason);
          const addr = getValue(t, CONFIG.fields.addr);
          const name = getValue(t, CONFIG.fields.name);

          let cssClass = "";
          let tagText = "";
          let tagColor = "#666";

          if (d === DATE_MAP.today) {
            cssClass = "is-today"; tagText = "ä»Šå¤©"; tagColor = "#28a745";
          } else if (d === DATE_MAP.tomorrow) {
            cssClass = "is-tomorrow"; tagText = "æ˜å¤©"; tagColor = "#17a2b8";
          } else if (d < DATE_MAP.today) {
            cssClass = "is-overdue"; tagText = `éæœŸ ${d}`; tagColor = "#dc3545";
          } else {
            tagText = d;
          }

          return `
            <div class="task-item ${cssClass}">
              <div class="task-header">
                <span>${escapeHtml(name || "(æœªå¡«å®¢å)")}</span>
                <span class="tag" style="background:${tagColor}">${escapeHtml(tagText)}</span>
              </div>
              <div class="task-detail">
                <strong>${escapeHtml(task || "(æœªå¡«äº‹é …)")}</strong><br>
                <span style="color:#666;">ğŸ“ ${escapeHtml(addr || "(æœªå¡«åœ°å€)")}</span>
              </div>
            </div>
          `;
        }).join("");

        html += `</div>`;
      }

      html += `</div>`;
      document.getElementById("app").innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // =============================
    // 7) åˆå§‹åŒ–
    // =============================
    function init() {
      ["chkYesterday", "chkToday", "chkTomorrow"].forEach(id => {
        document.getElementById(id).addEventListener("change", () => render(ALL_RECORDS));
      });

      document.getElementById("btnReload").addEventListener("click", () => loadFromRagic());

      syncCheckStyle();
      loadFromRagic();
    }

    init();
  </script>
</body>
</html>
