<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï¼‰</title>
  <style>
    :root{
      --bg:#eef1f4;
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --shadow2: 0 3px 10px rgba(0,0,0,0.06);
      --green:#16a34a;
      --red:#dc2626;
      --blue:#0891b2;
      --dark:#111827;
      --chip:#f3f4f6;
      --chipOn:#e7f1ff;
      --chipBorder:#3b82f6;

      --amber:#f59e0b;     /* å»¶æœŸ/æ˜¨å¤©æœªå®Œæˆ */
      --ghost:#e5e7eb;     /* æ¨ç®— */
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Microsoft JhengHei", system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--text);
      background:var(--bg);
      padding: max(12px, env(safe-area-inset-top)) 12px max(14px, env(safe-area-inset-bottom));
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== Top Controls (mobile first) ===== */
    .controls{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border:1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow2);
      border-radius: 14px;
      padding: 12px;
      margin: 0 auto 12px auto;
      max-width: 1100px;
    }

    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .updated{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
    }

    /* ===== Scrollable chips ===== */
    .dayStrip{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 2px;
      align-items:center;
      max-width: 100%;
    }
    .dayStrip::-webkit-scrollbar{ display:none; }

    .chipBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--chip);
      border: 2px solid transparent;
      user-select:none;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      line-height: 1;
      touch-action: manipulation;
      flex: 0 0 auto;
      scroll-snap-align: start;
      white-space: nowrap;
    }
    .chipBtn.on{
      background: var(--chipOn);
      border-color: var(--chipBorder);
      color: #0b3a82;
    }
    .chipBtn .sub{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      margin-left: 2px;
    }

    .searchBox{
      flex: 1 1 220px;
      display:flex;
      gap:8px;
      min-width: 220px;
    }
    .searchBox input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .btn{
      border:0;
      background: var(--dark);
      color:#fff;
      padding: 11px 12px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .stats{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      text-align:left;
      line-height: 1.5;
    }

    /* ===== Assignment zone ===== */
    #assignZone{ max-width:1100px; margin:0 auto 12px; }
    .assignCard{
      background: var(--card);
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .assignHead{
      padding: 12px 14px;
      border-left: 6px solid var(--green);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .assignTitle{
      font-size: 15px;
      font-weight: 900;
      margin:0;
    }
    .assignHint{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-top: 4px;
      line-height: 1.4;
    }
    .assignBody{ padding: 12px 12px 14px; border-top: 1px solid var(--line); }

    .assignGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 900px){
      .assignGrid{ grid-template-columns: 340px 1fr; }
    }
    .panel{
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding: 10px;
    }
    .panel h3{
      margin: 0 0 8px;
      font-size: 13px;
      font-weight: 900;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .staffChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #f8fafc;
      cursor: pointer;
      user-select:none;
      font-weight: 900;
      font-size: 13px;
    }
    .staffChip .dot{
      width: 10px; height:10px; border-radius:999px;
      background: var(--blue);
    }
    .staffChip.unused .dot{ background: var(--amber); }
    .staffChip.on{
      outline: 2px solid rgba(59,130,246,.35);
      box-shadow: 0 0 0 6px rgba(59,130,246,.12);
    }
    .staffChip[draggable="true"]{ cursor: grab; }
    .staffChip:active{ cursor: grabbing; }

    .miniRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .miniRow input[type="checkbox"]{ transform: scale(1.15); }
    .miniRow .miniText{ font-size:12px; color: var(--muted); font-weight: 800; }

    .assignList{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .dropTask{
      border: 1px solid var(--line);
      border-left: 6px solid #c7c7c7;
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
    }
    .dropTask.unassigned{ border-left-color: var(--red); background:#fff5f5; }
    .dropTask.ready{ outline: 2px dashed rgba(59,130,246,.55); outline-offset: 4px; }
    .dropTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      font-weight: 900;
    }
    .dropName{ font-size: 14px; }
    .dropMeta{
      margin-top:6px;
      font-size: 12px;
      color: #374151;
      line-height: 1.45;
    }

    .inlineForm{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 720px){
      .inlineForm{ grid-template-columns: 1fr 1fr auto; align-items:center; }
    }
    .inlineForm select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      outline:none;
      background:#fff;
      font-weight: 800;
      color: var(--text);
    }

    /* ===== Dashboard ===== */
    #app{ max-width: 1100px; margin: 0 auto; }
    .loading{
      text-align:center;
      color: var(--muted);
      padding: 40px 0;
      font-size: 16px;
      font-weight: 900;
    }
    .err{
      text-align:center;
      color: #b00020;
      padding: 18px;
      font-weight: 900;
      background: #fff;
      border: 1px solid #ffd2d6;
      border-radius: 14px;
      box-shadow: var(--shadow2);
    }

    .dashboard{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 820px){
      body{ padding: 18px 18px 22px; }
      .title h1{ font-size: 22px; }
      .dashboard{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1120px){
      .dashboard{ grid-template-columns: 1fr 1fr 1fr; }
    }

    /* ===== Person Card (accordion) ===== */
    details.card{
      background: var(--card);
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    summary.cardHead{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-top: 6px solid #6c757d;
    }
    summary.cardHead::-webkit-details-marker{ display:none; }

    .personName{
      font-size: 16px;
      font-weight: 900;
    }
    .personMeta{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      white-space:nowrap;
    }
    .badge{
      background: #111827;
      color: #fff;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
    }

    .tasks{
      padding: 10px 12px 12px;
      border-top: 1px solid var(--line);
    }

    .task{
      border: 1px solid var(--line);
      border-left: 6px solid #c7c7c7;
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
      margin-bottom: 10px;
    }
    .task:last-child{ margin-bottom:0; }

    .task.is-yesterday{ border-left-color: #9ca3af; background:#fff; }
    .task.is-today{ border-left-color: var(--green); background:#ecfdf3; }
    .task.is-tomorrow{ border-left-color: var(--blue); background:#e6fbff; }

    .taskTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      font-weight: 900;
    }
    .taskName{ font-size: 15px; }

    .tagWrap{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
      max-width: 52%;
    }

    .tag{
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      color:#fff;
      white-space:nowrap;
    }

    .tagMini{
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .tagDelay{ background: var(--amber); color:#111827; }
    .tagInferred{ background: var(--ghost); color:#111827; }
    .tagTime{ background:#111827; color:#fff; }

    /* âœ… æ²’é ç´„æ™‚é–“æ¨™ç¤º */
    .tagNoTime{
      background:#fff7ed;
      color:#9a3412;
    }

    .detail{
      margin-top: 6px;
      font-size: 13px;
      line-height: 1.45;
      color: #374151;
    }
    .muted{ color: var(--muted); font-weight: 800; }

    /* toast */
    .toast{
      position: fixed;
      left:50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow2);
      font-weight: 900;
      font-size: 13px;
      display:none;
      max-width: min(92vw, 720px);
      z-index: 999;
    }
  </style>
</head>
<body>

  <div class="controls">
    <div class="title">
      <h1>å…¨å®¶ç¦æ—©æœƒçœ‹æ¿ï¼ˆæ‰‹æ©Ÿå„ªå…ˆï½œæ˜¨å¤©/ä»Šå¤©/æ˜å¤©ï¼‰</h1>
      <div class="updated" id="updatedAt">â€”</div>
    </div>

    <div class="row">
      <div class="dayStrip" id="dayStrip"></div>

      <div class="searchBox">
        <input id="q" placeholder="æœå°‹ï¼šå®¢å / äº‹é … / åœ°å€ï¼ˆè¼¸å…¥å°±æœƒç¯©ï¼‰" />
        <button class="btn" id="btnReload">é‡è¼‰</button>
      </div>
    </div>

    <div class="stats" id="stats"></div>
  </div>

  <!-- âœ… ä»Šå¤©æ´¾å·¥ï¼ˆåªåœ¨ä»Šå¤©é¡¯ç¤ºï¼‰ -->
  <div id="assignZone"></div>

  <div id="app" class="loading">è³‡æ–™è®€å–ä¸­...</div>

  <div class="toast" id="toast"></div>

<script>
  const CONFIG = {
    apiKey: "UGQ4cGFmNjg2R0J2TXNSMXpZdVVvSlhIUVRLZHo2SmpISXUyMFQrRCtySXFDTUk2T2NCeUY4b0FDcXJ6OENqRA==",
    baseUrl: "https://ap12.ragic.com/89793238/fami/2",
    fields: {
      status: "1000111",
      date:   "1000122",
      person: "1000113",
      reason: "1000120",
      addr:   "1000119",
      name:   "1000116"
    },

    // âœ… ä½ å¡«ã€Œå…¨é«”å¸«å‚…åå–®ã€æ‰èƒ½ç®—å‡ºã€Œä»Šå¤©æœªæŒ‡æ´¾çš„äººã€
    staffList: [
      // "é˜¿æ˜", "é˜¿å¿—", "é˜¿è±ª",
    ],

    // âœ… çœŸè¦ã€ŒæŒ‡æ´¾å¯«å› Ragicã€è«‹ç”¨ Proxyï¼ˆä¸è¦å‰ç«¯ç›´æ¥æ‰“ PATCHï¼‰
    // ä½ å¯ä»¥å…ˆæŠŠ enabled=falseï¼Œç”¨ç´”å‰ç«¯æœƒè­°æ“ä½œï¼›è¦å¯«å›å†æ‰“é–‹ã€‚
    assign: {
      enabled: false,
      proxyUrl: "" // ä¾‹ï¼šhttps://script.google.com/macros/s/XXXX/exec
    }
  };

  const PENDING_STATUSES = ["å¾…è™•ç†", "æœªå®Œæˆ", "å»¶æœŸ"];
  const DONE_STATUSES    = ["å·²å®Œæˆ"]; // åªçµ¦ã€Œæ˜¨å¤©ï½œå·²å®Œæˆã€ç”¨

  // é€™è£¡æŠ“è³‡æ–™æœƒæŠŠã€Œå¾…è¾¦ + å·²å®Œæˆã€ä¸€èµ·æŠ“å›ä¾†ï¼Œå‰ç«¯å†ä¾ã€Œæ˜¨å¤©/ä»Šå¤©/æ˜å¤©ã€èˆ‡æ¨¡å¼åˆ‡ã€‚
  const FETCH_STATUSES = Array.from(new Set([...PENDING_STATUSES, ...DONE_STATUSES]));

  const startOfDay = (d) => {
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  };

  const toStr = (d) =>
    d.getFullYear() + "/" +
    String(d.getMonth()+1).padStart(2,"0") + "/" +
    String(d.getDate()).padStart(2,"0");

  const escapeHtml = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");

  const setUpdatedNow = () => {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    document.getElementById("updatedAt").innerText = `æ›´æ–° ${hh}:${mm}`;
  };

  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> el.style.display="none", 2200);
  }

  function jsonp(url) {
    return new Promise((resolve, reject) => {
      const cb = "__ragic_cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      window[cb] = (data) => { cleanup(); resolve(data); };

      const s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + encodeURIComponent(cb);
      s.onerror = () => { cleanup(); reject(new Error("JSONP failed")); };

      function cleanup(){
        try { delete window[cb]; } catch(e){ window[cb] = undefined; }
        s.remove();
      }
      document.head.appendChild(s);
    });
  }

  function getValue(r, id){
    const v = r?.[id];
    if (v == null) return "";
    if (typeof v === "object") return (v.value ?? v._index_title_ ?? v.name ?? "").toString();
    return v.toString();
  }

  // âœ… æ—¥æœŸæ­£è¦åŒ–ï¼šYYYY/MM/DD
  function normalizeDate10(raw){
    const s = String(raw ?? "").trim();
    if (!s) return "";
    const m = s.match(/(20\d{2})[\/\-](\d{2})[\/\-](\d{2})/);
    if (m) return `${m[1]}/${m[2]}/${m[3]}`;
    const m2 = s.match(/\b(20\d{2})(\d{2})(\d{2})\b/);
    if (m2) return `${m2[1]}/${m2[2]}/${m2[3]}`;
    return "";
  }

  // âœ… æŠ½å‡ºæ™‚é–“ HH:MMï¼ˆå¾æ—¥æœŸæ¬„ä½å­—ä¸²å…§ï¼‰
  function normalizeTimeHM(raw){
    const s = String(raw ?? "").trim();
    if (!s) return "";
    const m = s.match(/(?:\s|T)(\d{1,2}):(\d{2})(?::\d{2})?/);
    if (!m) return "";
    const hh = String(Math.min(23, Math.max(0, parseInt(m[1], 10)))).padStart(2, "0");
    const mm = String(Math.min(59, Math.max(0, parseInt(m[2], 10)))).padStart(2, "0");
    return `${hh}:${mm}`;
  }

  // âœ… HH:MM -> minutesï¼ˆç”¨æ–¼æ’åºï¼‰
  function timeToMin(hm){
    const s = String(hm ?? "").trim();
    if (!s) return null;
    const parts = s.split(":");
    if (parts.length < 2) return null;
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1], 10);
    if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
    return hh * 60 + mm;
  }

  // âœ… ç”¨å–®è™Ÿ(EID)æ¨ç®—æ—¥æœŸï¼ˆä½ åŸæœ¬å°±æœ‰ï¼‰
  function inferDateFromEid(eid){
    const s = String(eid ?? "").trim();
    if (!s) return "";
    const m = s.match(/(20\d{2})[\/\-]?(\d{2})[\/\-]?(\d{2})/);
    if (!m) return "";
    return `${m[1]}/${m[2]}/${m[3]}`;
  }

  // ===== æ—¥æœŸï¼šåªä¿ç•™ æ˜¨å¤©/ä»Šå¤©/æ˜å¤© =====
  const TODAY = startOfDay(new Date());
  const YESTERDAY = new Date(TODAY); YESTERDAY.setDate(YESTERDAY.getDate() - 1);
  const TOMORROW  = new Date(TODAY); TOMORROW.setDate(TOMORROW.getDate() + 1);

  const DAY_STR = {
    yesterday: toStr(YESTERDAY),
    today: toStr(TODAY),
    tomorrow: toStr(TOMORROW),
  };

  let ACTIVE_DAY = "today";      // yesterday | today | tomorrow
  let Y_MODE = "todo";           // todo | doneï¼ˆæ˜¨å¤©æ‰æœ‰ï¼‰
  let ALL_RECORDS = [];
  let IS_LOADING = false;

  // æ´¾å·¥ç‹€æ…‹
  let SELECTED_STAFF = "";
  let ALLOW_OVERWRITE = false;

  function setLoading(flag){
    IS_LOADING = flag;
    document.getElementById("btnReload").disabled = flag;
  }

  function buildDayChips(){
    const wrap = document.getElementById("dayStrip");
    wrap.innerHTML = `
      <button class="chipBtn on" data-day="yesterday" id="btnYesterday">
        æ˜¨å¤© <span class="sub">${DAY_STR.yesterday.slice(5)}</span>
      </button>
      <button class="chipBtn on" data-day="today" id="btnToday">
        ä»Šå¤© <span class="sub">${DAY_STR.today.slice(5)}</span>
      </button>
      <button class="chipBtn on" data-day="tomorrow" id="btnTomorrow">
        æ˜å¤© <span class="sub">${DAY_STR.tomorrow.slice(5)}</span>
      </button>

      <span style="width:8px;flex:0 0 auto;"></span>

      <button class="chipBtn" data-ymode="todo" id="btnYTodo" style="display:none">
        æ˜¨å¤©ï½œæœªå®Œæˆ
      </button>
      <button class="chipBtn" data-ymode="done" id="btnYDone" style="display:none">
        æ˜¨å¤©ï½œå·²å®Œæˆ
      </button>
    `;

    wrap.addEventListener("click", (e)=>{
      const dayBtn = e.target.closest("[data-day]");
      const modeBtn = e.target.closest("[data-ymode]");

      if (dayBtn){
        setActiveDay(dayBtn.dataset.day);
        return;
      }
      if (modeBtn){
        setYesterdayMode(modeBtn.dataset.ymode);
        return;
      }
    });

    // defaultï¼šä»Šå¤©
    setActiveDay("today", true);
  }

  function setActiveDay(day, skipRender=false){
    ACTIVE_DAY = day;

    // ä¸»ä¸‰éµ UI
    ["yesterday","today","tomorrow"].forEach(k=>{
      const el = document.getElementById(`btn${k[0].toUpperCase()+k.slice(1)}`);
      if (!el) return;
      el.classList.toggle("on", k === day);
    });

    // æ˜¨å¤©æ¨¡å¼éµé¡¯ç¤º/éš±è—
    const yTodo = document.getElementById("btnYTodo");
    const yDone = document.getElementById("btnYDone");
    const showY = (day === "yesterday");
    yTodo.style.display = showY ? "inline-flex" : "none";
    yDone.style.display = showY ? "inline-flex" : "none";

    // æ˜¨å¤©æ¨¡å¼é è¨­ï¼šæœªå®Œæˆ
    if (showY && !["todo","done"].includes(Y_MODE)) Y_MODE = "todo";
    setYesterdayMode(Y_MODE, true);

    if (!skipRender) render();
  }

  function setYesterdayMode(mode, skipRender=false){
    if (!["todo","done"].includes(mode)) mode = "todo";
    Y_MODE = mode;

    const yTodo = document.getElementById("btnYTodo");
    const yDone = document.getElementById("btnYDone");
    if (yTodo && yDone){
      yTodo.classList.toggle("on", Y_MODE==="todo");
      yDone.classList.toggle("on", Y_MODE==="done");
    }
    if (!skipRender) render();
  }

  async function loadFromRagic(){
    if (!CONFIG.apiKey || CONFIG.apiKey.includes("__PUT")){
      document.getElementById("app").innerHTML =
        `<div class="err">è«‹å…ˆåœ¨ CONFIG.apiKey å¡«å…¥å¯ç”¨çš„ API Key</div>`;
      return;
    }

    try{
      setLoading(true);
      document.getElementById("app").innerHTML = `<div class="loading">è³‡æ–™è®€å–ä¸­...</div>`;

      const params = new URLSearchParams();
      params.set("api","");
      params.set("APIKey", CONFIG.apiKey);
      params.set("naming","EID");
      params.set("limit","1000");
      params.set("reverse","true");

      // âœ… æŠ“ã€Œå¾…è¾¦ + å·²å®Œæˆã€(æ˜¨å¤©å·²å®Œæˆéœ€è¦)
      for (const st of FETCH_STATUSES){
        params.append("where", `${CONFIG.fields.status},eq,${st}`);
      }

      const url = `${CONFIG.baseUrl}?${params.toString()}`;
      const data = await jsonp(url);

      ALL_RECORDS = Object.entries(data || {})
        .filter(([eid, v]) => v && typeof v === "object" && v._ragicId !== 0)
        .map(([eid, v]) => {
          const rawDate = getValue(v, CONFIG.fields.date);
          const d10_from_field = normalizeDate10(rawDate);
          const time_from_field = normalizeTimeHM(rawDate);
          const d10_from_eid   = inferDateFromEid(eid);

          v.__eid = eid;
          v.__date10 = d10_from_field || d10_from_eid || "";
          v.__time = time_from_field || "";   // HH:MM
          v.__dateSource = d10_from_field ? "field" : (d10_from_eid ? "eid" : "");

          return v;
        });

      setUpdatedNow();
      render();
    }catch(err){
      console.error(err);
      document.getElementById("app").innerHTML =
        `<div class="err">è®€å–å¤±æ•—ï¼šè«‹æª¢æŸ¥ baseUrl(ap12)ã€APIKey æ¬Šé™ã€æˆ–ç‹€æ…‹å­—ä¸²æ˜¯å¦å®Œå…¨ä¸€è‡´</div>`;
    }finally{
      setLoading(false);
    }
  }

  function statusAllowedForCurrentView(status){
    if (status === "å–æ¶ˆ") return false;

    if (ACTIVE_DAY === "yesterday"){
      if (Y_MODE === "done") return DONE_STATUSES.includes(status);
      return PENDING_STATUSES.includes(status);
    }
    // today / tomorrow
    return PENDING_STATUSES.includes(status);
  }

  function getDayTagColor(day){
    if (day === "today") return "#16a34a";
    if (day === "tomorrow") return "#0891b2";
    return "#6b7280";
  }

  function getDayCardClass(day){
    if (day === "today") return "is-today";
    if (day === "tomorrow") return "is-tomorrow";
    return "is-yesterday";
  }

  function parsePeople(raw){
    const s = String(raw ?? "").trim();
    if (!s) return [];
    return s.split(/[,ã€\n]+/).map(x=>x.trim()).filter(Boolean);
  }

  function buildAssignZone(todayRecords){
    const zone = document.getElementById("assignZone");
    zone.innerHTML = "";

    // åªåœ¨ã€Œä»Šå¤©ã€é¡¯ç¤º
    if (ACTIVE_DAY !== "today") return;

    // æ²’å¡«å…¨é«”åå–®å°±ä¸é¡¯ç¤ºï¼ˆä¸ç„¶ç®—ä¸å‡ºâ€œæœªæŒ‡æ´¾çš„äººâ€ï¼‰
    if (!Array.isArray(CONFIG.staffList) || CONFIG.staffList.length === 0) return;

    const todayUnassignedTasks = todayRecords.filter(r => !getValue(r, CONFIG.fields.person));
    const used = new Set();
    for (const r of todayRecords){
      const people = parsePeople(getValue(r, CONFIG.fields.person));
      people.forEach(p=> used.add(p));
    }
    const unUsedStaff = CONFIG.staffList.filter(n => !used.has(n));

    const taskOptions = todayUnassignedTasks.map(r=>{
      const name = getValue(r, CONFIG.fields.name) || "(æœªå¡«å®¢å)";
      const t = r.__time ? `ï½œ${r.__time}` : "";
      const eid = r.__eid || "";
      return `<option value="${escapeHtml(eid)}">${escapeHtml(name)}${escapeHtml(t)}ï½œ${escapeHtml(eid)}</option>`;
    }).join("");

    const staffOptions = CONFIG.staffList.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

    zone.innerHTML = `
      <div class="assignCard">
        <div class="assignHead">
          <div>
            <div class="assignTitle">ä»Šå¤©æ´¾å·¥ï¼ˆæœƒè­°å¿«é€ŸæŒ‡æ´¾ï¼‰</div>
            <div class="assignHint">
              æ¡Œæ©Ÿï¼šæ‹–æ‹‰å¸«å‚…æ–¹å¡Š â†’ ä¸Ÿåˆ°ã€ŒæœªæŒ‡æ´¾å–®ã€<br>
              æ‰‹æ©Ÿï¼šå…ˆé»å¸«å‚… â†’ å†é»å–®å­ï¼ˆæ‹–æ‹‰å¯èƒ½ä¸ç©©ï¼‰<br>
              ç›®å‰ï¼šæœªæŒ‡æ´¾å–® ${todayUnassignedTasks.length}ï½œæœªæŒ‡æ´¾å¸«å‚… ${unUsedStaff.length}
            </div>
          </div>
          <button class="btn" id="btnAssignRefresh" style="background:#111827">åˆ·æ–°æ´¾å·¥</button>
        </div>

        <div class="assignBody">
          <div class="assignGrid">
            <div class="panel">
              <h3>ä»Šå¤©æœªæŒ‡æ´¾çš„å¸«å‚…ï¼ˆæ–¹å¡Šï¼‰</h3>
              <div class="chips" id="unusedStaffChips">
                ${unUsedStaff.length ? unUsedStaff.map(n=>`
                  <div class="staffChip unused" draggable="true" data-staff="${escapeHtml(n)}">
                    <span class="dot"></span>${escapeHtml(n)}
                  </div>
                `).join("") : `<div class="muted">ï¼ˆä»Šå¤©æ¯ä½å¸«å‚…éƒ½å·²å‡ºç¾åœ¨å–®å­ä¸Šï¼‰</div>`}
              </div>

              <div style="height:10px"></div>
              <h3>å…¨éƒ¨å¸«å‚…</h3>
              <div class="chips" id="allStaffChips">
                ${CONFIG.staffList.map(n=>`
                  <div class="staffChip" draggable="true" data-staff="${escapeHtml(n)}">
                    <span class="dot"></span>${escapeHtml(n)}
                  </div>
                `).join("")}
              </div>

              <div class="miniRow">
                <label style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" id="chkOverwrite">
                  <span class="miniText">å…è¨±è¦†å¯«åŸæŒ‡æ´¾ï¼ˆé è¨­é—œé–‰ï¼Œé¿å…æ‰‹æ»‘ï¼‰</span>
                </label>
              </div>

              <div class="miniRow">
                <span class="miniText" id="selectedStaffHint">æœªé¸å–å¸«å‚…</span>
              </div>
            </div>

            <div class="panel">
              <h3>ä»Šå¤©æœªæŒ‡æ´¾å–®ï¼ˆå¯æ¥æ”¶æ‹–æ‹‰ / é»é¸æŒ‡æ´¾ï¼‰</h3>
              <div class="assignList" id="unassignedTaskList">
                ${todayUnassignedTasks.length ? todayUnassignedTasks.map(r=>{
                  const eid = r.__eid || "";
                  const name = getValue(r, CONFIG.fields.name) || "(æœªå¡«å®¢å)";
                  const task = getValue(r, CONFIG.fields.reason) || "(æœªå¡«äº‹é …)";
                  const addr = getValue(r, CONFIG.fields.addr) || "(æœªå¡«åœ°å€)";
                  const time = r.__time || "";
                  const inferred = (r.__dateSource === "eid");
                  return `
                    <div class="dropTask unassigned" data-task-eid="${escapeHtml(eid)}">
                      <div class="dropTop">
                        <div class="dropName">${escapeHtml(name)} ${time ? `ï½œ${escapeHtml(time)}` : ""}</div>
                        <div class="badge">å¾…æŒ‡æ´¾</div>
                      </div>
                      <div class="dropMeta">
                        <div><b>${escapeHtml(task)}</b></div>
                        <div class="muted">ğŸ“ ${escapeHtml(addr)}</div>
                        ${inferred ? `<div class="muted">ï¼ˆå–®è™Ÿæ¨ç®—æ—¥æœŸï¼‰</div>` : ``}
                        <div class="muted">EIDï¼š${escapeHtml(eid)}</div>
                      </div>
                    </div>
                  `;
                }).join("") : `<div class="muted">ï¼ˆä»Šå¤©æ²’æœ‰æœªæŒ‡æ´¾å–®ï¼‰</div>`}
              </div>

              <div class="inlineForm">
                <select id="selTask">${taskOptions || `<option value="">ï¼ˆä»Šå¤©æ²’æœ‰æœªæŒ‡æ´¾å–®ï¼‰</option>`}</select>
                <select id="selStaff">${staffOptions}</select>
                <button class="btn" id="btnAssignApply" style="background:#111827">ç”¨ä¸‹æ‹‰æŒ‡æ´¾</button>
              </div>

              <div class="assignHint" style="margin-top:8px">
                å¦‚æœä½ è¦ã€ŒçœŸçš„å¯«å› Ragicã€ï¼šæŠŠ CONFIG.assign.enabled æ”¹ trueï¼Œä¸¦å¡« proxyUrlã€‚
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // ç¶äº‹ä»¶
    document.getElementById("btnAssignRefresh").addEventListener("click", ()=> render());

    document.getElementById("chkOverwrite").addEventListener("change", (e)=>{
      ALLOW_OVERWRITE = !!e.target.checked;
    });

    // staff chipsï¼šclick + dragstart
    zone.querySelectorAll(".staffChip[data-staff]").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        SELECTED_STAFF = ch.dataset.staff || "";
        syncSelectedStaffUI();
      });
      ch.addEventListener("dragstart", (ev)=>{
        const s = ch.dataset.staff || "";
        SELECTED_STAFF = s;
        syncSelectedStaffUI();
        ev.dataTransfer.setData("text/plain", s);
      });
    });

    // tasksï¼šdrop + click
    zone.querySelectorAll(".dropTask[data-task-eid]").forEach(tk=>{
      tk.addEventListener("dragover", (ev)=>{ ev.preventDefault(); tk.classList.add("ready"); });
      tk.addEventListener("dragleave", ()=> tk.classList.remove("ready"));
      tk.addEventListener("drop", async (ev)=>{
        ev.preventDefault();
        tk.classList.remove("ready");
        const staff = ev.dataTransfer.getData("text/plain");
        const eid = tk.dataset.taskEid;
        if (staff && eid) await assignPersonToEid(eid, staff);
      });
      tk.addEventListener("click", async ()=>{
        const eid = tk.dataset.taskEid;
        if (!SELECTED_STAFF){
          toast("å…ˆé¸ä¸€ä½å¸«å‚…ï¼Œå†é»å–®å­");
          return;
        }
        await assignPersonToEid(eid, SELECTED_STAFF);
      });
    });

    document.getElementById("btnAssignApply").addEventListener("click", async ()=>{
      const eid = document.getElementById("selTask").value;
      const staff = document.getElementById("selStaff").value;
      if (!eid){ toast("ä»Šå¤©æ²’æœ‰å¯æŒ‡æ´¾çš„å–®"); return; }
      await assignPersonToEid(eid, staff);
    });

    syncSelectedStaffUI();
  }

  function syncSelectedStaffUI(){
    const zone = document.getElementById("assignZone");
    if (!zone) return;
    const hint = zone.querySelector("#selectedStaffHint");
    if (hint) hint.textContent = SELECTED_STAFF ? `å·²é¸å–ï¼š${SELECTED_STAFF}ï¼ˆé»å–®å­æˆ–æ‹–æ‹‰æŒ‡æ´¾ï¼‰` : "æœªé¸å–å¸«å‚…";

    zone.querySelectorAll(".staffChip[data-staff]").forEach(ch=>{
      ch.classList.toggle("on", (ch.dataset.staff||"") === SELECTED_STAFF);
    });
  }

  function findRecordByEid(eid){
    return ALL_RECORDS.find(r => String(r.__eid||"") === String(eid||""));
  }

  async function assignPersonToEid(eid, staff){
    const r = findRecordByEid(eid);
    if (!r){ toast("æ‰¾ä¸åˆ°é€™å¼µå–®ï¼ˆå¯èƒ½è³‡æ–™æœªæ›´æ–°ï¼‰"); return; }

    const cur = getValue(r, CONFIG.fields.person);
    if (cur && !ALLOW_OVERWRITE){
      toast(`é€™å¼µå–®å·²æŒ‡æ´¾ï¼š${cur}ï¼ˆè¦è¦†å¯«è«‹å‹¾å…è¨±è¦†å¯«ï¼‰`);
      return;
    }

    // âœ… å…ˆæ›´æ–°å‰ç«¯ï¼ˆæœƒè­°é«”æ„Ÿå¿«ï¼‰
    r[CONFIG.fields.person] = staff;

    // âœ… å¯é¸ï¼šå¯«å›
    if (CONFIG.assign.enabled && CONFIG.assign.proxyUrl){
      try{
        await fetch(CONFIG.assign.proxyUrl, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ action:"updatePerson", eid, person: staff })
        });
        toast(`å·²æŒ‡æ´¾ï¼š${staff}`);
      }catch(err){
        console.error(err);
        toast("å¯«å›å¤±æ•—ï¼ˆProxy/æ¬Šé™/CORSï¼‰â€” å·²å…ˆåœ¨ç•«é¢æ›´æ–°");
      }
    }else{
      toast(`å·²æŒ‡æ´¾ï¼ˆåƒ…ç•«é¢ï¼‰ï¼š${staff}`);
    }

    // é‡æ–° renderï¼šæ´¾å·¥å€ + ä¸‹æ–¹çœ‹æ¿æœƒåŒæ­¥
    render();
  }

  function render(){
    const query = (document.getElementById("q").value || "").trim().toLowerCase();

    // ç›®å‰é¸æ“‡çš„æ—¥æœŸå­—ä¸²
    const targetDate = DAY_STR[ACTIVE_DAY];

    // å…ˆåšã€Œä»Šå¤©æ´¾å·¥ã€çš„ä¾†æºï¼ˆä¸å—æœå°‹å½±éŸ¿ï¼‰
    const todayRecords = ALL_RECORDS.filter(r=>{
      const status = getValue(r, CONFIG.fields.status);
      const d = r.__date10 || "";
      if (!d) return false;
      if (d !== DAY_STR.today) return false;
      if (!PENDING_STATUSES.includes(status)) return false;
      if (status === "å–æ¶ˆ") return false;
      return true;
    });
    buildAssignZone(todayRecords);

    // å†åšä¸‹æ–¹ dashboardï¼ˆå—æœå°‹å½±éŸ¿ + ä¾æ˜¨å¤©æ¨¡å¼åˆ‡ï¼‰
    const filtered = ALL_RECORDS.filter(r=>{
      const status = getValue(r, CONFIG.fields.status);
      const d = r.__date10 || "";
      if (!d) return false;
      if (d !== targetDate) return false;
      if (!statusAllowedForCurrentView(status)) return false;

      if (!query) return true;

      const name = getValue(r, CONFIG.fields.name);
      const task = getValue(r, CONFIG.fields.reason);
      const addr = getValue(r, CONFIG.fields.addr);
      const person = getValue(r, CONFIG.fields.person);
      const eid = r.__eid || "";
      const hay = `${name} ${task} ${addr} ${person} ${eid}`.toLowerCase();
      return hay.includes(query);
    });

    // stats
    const inferredCount = filtered.filter(r => r.__dateSource === "eid").length;
    const noTimeShown = filtered.filter(r => !r.__time).length;

    const modeText =
      (ACTIVE_DAY === "yesterday")
        ? (Y_MODE === "done" ? "æ˜¨å¤©ï½œå·²å®Œæˆ" : "æ˜¨å¤©ï½œæœªå®Œæˆ")
        : (ACTIVE_DAY === "today" ? "ä»Šå¤©" : "æ˜å¤©");

    document.getElementById("stats").innerText =
      `æ¨¡å¼ï¼š${modeText}ï¼ˆ${targetDate}ï¼‰ï½œé¡¯ç¤º ${filtered.length}ï½œğŸ”œ æœªç´„æ™‚é–“ ${noTimeShown}ï½œå–®è™Ÿæ¨ç®— ${inferredCount}`;

    if (filtered.length === 0){
      document.getElementById("app").innerHTML =
        `<div class="loading">æ­¤ç¯„åœæ²’æœ‰è³‡æ–™</div>`;
      return;
    }

    const grouped = filtered.reduce((acc, r) => {
      const p = getValue(r, CONFIG.fields.person) || "å¾…æŒ‡æ´¾";
      (acc[p] ||= []).push(r);
      return acc;
    }, {});

    const isMobile = window.matchMedia("(max-width: 640px)").matches;

    // æ’åºï¼šæ™‚é–“ï¼ˆæ²’æ™‚é–“æœ€å¾Œï¼‰-> å®¢åï¼ˆç©©å®šï¼‰
    for (const person of Object.keys(grouped)){
      grouped[person].sort((a,b)=>{
        const ta = timeToMin(a.__time);
        const tb = timeToMin(b.__time);
        const va = (ta == null) ? 99999 : ta;
        const vb = (tb == null) ? 99999 : tb;
        if (va !== vb) return va - vb;

        const na = (getValue(a, CONFIG.fields.name) || "").toString();
        const nb = (getValue(b, CONFIG.fields.name) || "").toString();
        return na.localeCompare(nb, "zh-Hant");
      });
    }

    const dayColor = getDayTagColor(ACTIVE_DAY);
    const dayCls = getDayCardClass(ACTIVE_DAY);

    let html = `<div class="dashboard">`;

    for (const person of Object.keys(grouped).sort((a,b)=>a.localeCompare(b,"zh-Hant"))){
      const tasks = grouped[person];
      const openAttr = (!isMobile) ? "open" : "";

      // person å¡ç‰‡é ‚è‰²ï¼šæœ‰å¾…æŒ‡æ´¾â†’ç´…ï¼›å¦å‰‡ç”¨ç•¶å¤©é¡è‰²
      const hasUnassigned = (person === "å¾…æŒ‡æ´¾");
      const topColor = hasUnassigned ? "#dc2626" : dayColor;

      html += `
        <details class="card" ${openAttr}>
          <summary class="cardHead" style="border-top-color:${topColor}">
            <div class="personName">${escapeHtml(person)}</div>
            <div class="personMeta">
              <span class="badge">${tasks.length}</span>
              <span class="muted">${hasUnassigned ? "å¾…æŒ‡æ´¾" : ""}</span>
            </div>
          </summary>
          <div class="tasks">
      `;

      html += tasks.map(t=>{
        const status = getValue(t, CONFIG.fields.status);
        const name = getValue(t, CONFIG.fields.name) || "(æœªå¡«å®¢å)";
        const task = getValue(t, CONFIG.fields.reason) || "(æœªå¡«äº‹é …)";
        const addr = getValue(t, CONFIG.fields.addr) || "(æœªå¡«åœ°å€)";
        const inferred = (t.__dateSource === "eid");
        const noTime = !t.__time;

        const tagText =
          (ACTIVE_DAY === "today") ? "ä»Šå¤©" :
          (ACTIVE_DAY === "tomorrow") ? "æ˜å¤©" :
          "æ˜¨å¤©";

        const showDelayBadge = (status === "å»¶æœŸ");

        return `
          <div class="task ${dayCls}">
            <div class="taskTop">
              <div class="taskName">${escapeHtml(name)}</div>
              <div class="tagWrap">
                <div class="tag" style="background:${dayColor}">${escapeHtml(tagText)}</div>
                ${t.__time ? `<div class="tagMini tagTime">â° ${escapeHtml(t.__time)}</div>` : `<div class="tagMini tagNoTime">ğŸ”œ æœªç´„æ™‚é–“</div>`}
                ${showDelayBadge ? `<div class="tagMini tagDelay">å»¶æœŸ</div>` : ``}
                ${inferred ? `<div class="tagMini tagInferred">å–®è™Ÿæ¨ç®—</div>` : ``}
              </div>
            </div>
            <div class="detail">
              <div><b>${escapeHtml(task)}</b></div>
              <div class="muted">ğŸ“ ${escapeHtml(addr)}</div>
              <div class="muted">ç‹€æ…‹ï¼š${escapeHtml(status)}ï½œEIDï¼š${escapeHtml(t.__eid || "")}</div>
            </div>
          </div>
        `;
      }).join("");

      html += `</div></details>`;
    }

    html += `</div>`;
    document.getElementById("app").innerHTML = html;
  }

  function init(){
    buildDayChips();

    document.getElementById("q").addEventListener("input", render);
    document.getElementById("btnReload").addEventListener("click", loadFromRagic);

    loadFromRagic();
  }

  init();
</script>
</body>
</html>
