<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>成本試算積木計算器</title>
  <style>
    :root {
      --bg-body: #060814;
      --bg-card: #111626;
      --bg-subcard: #151a2b;
      --bg-tag: #1e293b;
      --accent: #4f46e5;
      --accent-soft: #6366f1;
      --accent-danger: #fb7185;
      --accent-success: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --shadow-soft: 0 18px 35px rgba(15,23,42,0.6);
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
      color: var(--text-main);
      line-height: 1.5;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 18px;
    }

    header h1 {
      margin: 0 0 4px 0;
      font-size: 22px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.badge {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 999px;
      background: linear-gradient(120deg, #4f46e5, #ec4899);
      color: #f9fafb;
    }

    header p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }

    @media (max-width: 960px) {
      body { padding: 16px; }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: linear-gradient(145deg, rgba(15,23,42,0.97), rgba(15,23,42,0.88));
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.18);
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(79,70,229,0.18), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel h2 {
      margin: 0 0 8px 0;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel h2 span.tag {
      font-size: 11px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-muted);
    }

    .sub-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* inputs */
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .input-row > div {
      flex: 1;
      min-width: 150px;
    }

    label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      margin: 4px 0 2px;
      color: var(--text-muted);
    }

    label span.label-main {
      color: var(--text-main);
      font-size: 12px;
    }

    label small {
      font-size: 11px;
      color: var(--text-muted);
      margin-left: 4px;
    }

    input, select {
      width: 100%;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    input:focus, select:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(99,102,241,0.45);
      background: rgba(15,23,42,0.98);
    }

    hr {
      border: none;
      border-top: 1px dashed rgba(148,163,184,0.35);
      margin: 10px 0;
    }

    .base-summary {
      background: var(--bg-subcard);
      border-radius: var(--radius-md);
      padding: 8px 10px;
      font-size: 12px;
      margin-top: 4px;
      border: 1px solid rgba(148,163,184,0.2);
    }

    .base-summary div {
      margin-bottom: 3px;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.3);
      color: var(--text-muted);
    }

    .badge-pill span {
      color: #e5e7eb;
      font-weight: 600;
    }

    .formula-block {
      font-size: 11px;
      background: #020617;
      border-radius: var(--radius-md);
      border: 1px solid rgba(30,64,175,0.7);
      padding: 6px 8px;
      margin-top: 8px;
      white-space: pre-line;
      color: #e5e7eb;
    }

    .formula-block .title {
      font-size: 11px;
      color: #a5b4fc;
      margin-bottom: 2px;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .value {
      font-weight: 600;
      color: #e5e7eb;
    }

    /* rules area */
    #rulesContainer {
      margin-top: 6px;
    }

    .rule-block {
      background: var(--bg-subcard);
      border-radius: 14px;
      padding: 8px 9px;
      margin-bottom: 8px;
      border: 1px solid rgba(148,163,184,0.24);
      position: relative;
      box-shadow: 0 10px 24px rgba(15,23,42,0.6);
      overflow: hidden;
    }

    .rule-block::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(to bottom, #6366f1, #ec4899);
      opacity: 0.9;
    }

    .rule-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .rule-title {
      font-weight: 600;
      flex: 1;
    }

    .rule-type-tag {
      font-size: 11px;
      padding: 1px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(129,140,248,0.7);
      color: #c7d2fe;
    }

    .toggle-label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .toggle-label input {
      width: auto;
      margin: 0;
    }

    .btn-delete {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.7);
      background: transparent;
      color: #fecaca;
      padding: 2px 8px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }

    .btn-delete:hover {
      background: rgba(248,113,113,0.15);
      transform: translateY(-0.5px);
    }

    .rule-body {
      font-size: 12px;
      margin-top: 2px;
    }

    .field-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .field-row > div {
      flex: 1;
      min-width: 135px;
    }

    .rule-summary {
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed rgba(148,163,184,0.4);
      white-space: pre-line;
      font-size: 11px;
      color: #e5e7eb;
    }

    .add-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }

    .add-row select {
      max-width: 220px;
    }

    .add-row button {
      padding: 5px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      background: linear-gradient(120deg, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(22,163,74,0.45);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s;
    }

    .add-row button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 16px 30px rgba(22,163,74,0.6);
    }

    .add-row button span.plus {
      font-size: 14px;
    }

    /* total summary */
    .total-summary {
      background: var(--bg-subcard);
      border-radius: var(--radius-lg);
      padding: 9px 10px;
      border: 1px solid rgba(148,163,184,0.35);
      margin-top: 4px;
      font-size: 12px;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .total-line span.label {
      color: var(--text-muted);
    }

    .total-line span.value {
      font-weight: 600;
    }

    .total-highlight {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      background: radial-gradient(circle at left, rgba(52,211,153,0.18), transparent),
                  radial-gradient(circle at right, rgba(239,68,68,0.22), transparent);
      border: 1px solid rgba(52,211,153,0.6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
    }

    .total-highlight-main {
      display: flex;
      flex-direction: column;
    }

    .total-highlight-main span.big {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #bbf7d0;
    }

    .total-highlight-main span.sub {
      font-size: 11px;
      color: #d1fae5;
    }

    .total-highlight-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-muted);
    }

    #total-formula {
      margin-top: 8px;
      border-color: rgba(52,211,153,0.6);
    }

  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>
        成本試算積木計算器
        <span class="badge">互動版 · 給老闆看得懂</span>
      </h1>
      <p>
        左邊填基本數字，右邊用「積木規則」疊折扣。  
        每一塊都會列出完整算式，金額自動換「萬」單位，方便檢查與決策。
      </p>
    </header>

    <div class="layout">
      <!-- 左：基本條件 -->
      <section class="panel">
        <div class="panel-inner">
          <h2>
            1. 基本條件
            <span class="tag">原始交易設定</span>
          </h2>
          <p class="sub-title">
            這區只處理：單價、數量、基礎折扣、門檻與階數。改這邊，右邊全部會跟著重算。
          </p>

          <div class="input-row">
            <div>
              <label>
                <span class="label-main">每台經銷價（未折扣，元）</span>
              </label>
              <input type="number" id="pricePerUnit" value="10000">
            </div>
            <div>
              <label>
                <span class="label-main">數量（台）</span>
              </label>
              <input type="number" id="quantity" value="200">
            </div>
          </div>

          <div class="input-row">
            <div>
              <label>
                <span class="label-main">基本折扣（％）</span>
                <small>例：9 = 9% 折扣 → 約 91 折</small>
              </label>
              <input type="number" id="baseDiscountPercent" value="9" step="0.1">
            </div>
          </div>

          <hr>

          <h3 style="margin:0 0 4px 0; font-size:13px;">滿額門檻設定</h3>
          <div class="input-row">
            <div>
              <label>
                <span class="label-main">滿額門檻金額（元）</span>
              </label>
              <input type="number" id="threshold" value="2000000">
            </div>
            <div>
              <label>
                <span class="label-main">超過門檻後，每一階金額（元）</span>
              </label>
              <input type="number" id="stepAmount" value="120000">
            </div>
          </div>

          <div class="base-summary">
            <div>
              <span class="badge-pill">
                未折扣金額：
                <span id="base-gross">0</span>
              </span>
            </div>
            <div>
              <span class="badge-pill">
                基本折扣：
                <span id="base-rate">0</span>％
              </span>
              &nbsp;&nbsp;→&nbsp;折扣後營業額：
              <span class="value" id="base-sales">0</span>
            </div>
            <div>
              門檻：<span class="value" id="base-threshold">0</span>
              ｜ 每階：<span class="value" id="base-step">0</span>
            </div>
            <div>
              超過門檻：<span class="value" id="base-exceed">0</span>
              ｜ 共 <span class="value" id="base-steps">0</span> 階
            </div>
          </div>

          <div class="formula-block" id="base-formula">
            <div class="title">【基本公式】</div>
          </div>

          <p class="hint">
            單位顯示：數字 ≥ 10,000 時會顯示為「x.xxxx(萬)」，方便快速判斷量級。
          </p>
        </div>
      </section>

      <!-- 右：規則積木 + 總結 -->
      <section class="panel">
        <div class="panel-inner">
          <h2>
            2. 規則積木
            <span class="tag">可增減 · 可啟用 / 停用</span>
          </h2>
          <p class="sub-title">
            每一條規則都是一塊積木：達成條件就送機器或現折。  
            你可以新增 / 刪除規則，也可以暫時取消勾選只看部分方案。
          </p>

          <div id="rulesContainer"></div>

          <div class="add-row">
            <select id="newRuleType">
              <option value="flatGift">滿額送機器（一次性）</option>
              <option value="stepGift">超額每一階送機器</option>
              <option value="stepPercent">超額每一階現金折扣％</option>
            </select>
            <button id="addRuleBtn">
              <span class="plus">＋</span>
              新增規則積木
            </button>
          </div>

          <p class="hint">
            例如你現在的需求：<br>
            ‧ 規則1：滿 200 萬送 A 機器 7 台 → 選「滿額送機器」<br>
            ‧ 規則2：超過 200 萬每 12 萬送 B 機器 1 台 → 選「超額每一階送機器」<br>
            ‧ 規則3：超過 200 萬每 12 萬再折 1% → 選「超額每一階現金折扣％」
          </p>

          <hr>

          <h2 style="margin-top:6px;">
            3. 總結
            <span class="tag">給老闆的結論區</span>
          </h2>

          <div class="total-summary">
            <div class="total-line">
              <span class="label">滿額回饋折掉金額</span>
              <span class="value" id="sum-extra-value">0</span>
            </div>
            <div class="total-line">
              <span class="label">滿額回饋折扣率</span>
              <span class="value" id="sum-extra-rate">0</span>％
            </div>
            <div class="total-line">
              <span class="label">基本折扣</span>
              <span class="value" id="sum-base-rate">0</span>％
            </div>

            <div class="total-highlight">
              <div class="total-highlight-main">
                <span class="sub">全部折扣（基本折扣 ＋ 滿額回饋）約等於</span>
                <span class="big" id="sum-fold">0.00 折</span>
              </div>
              <div class="total-highlight-chip">
                折掉 <span id="sum-total-rate">0</span>％ 的金額
              </div>
            </div>
          </div>

          <div class="formula-block" id="total-formula">
            <div class="title">【總結算式】</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    function $(id) { return document.getElementById(id); }

    function fmtRaw(n) {
      return n.toLocaleString("zh-TW", { maximumFractionDigits: 0 });
    }

    // >= 1 萬就顯示成 x.xxxx(萬)
    function fmtAmount(n) {
      const abs = Math.abs(n);
      if (abs >= 10000) {
        const wan = n / 10000;
        let s = wan.toFixed(4);
        s = s.replace(/0+$/,"").replace(/\.$/,"");
        return s + "(萬)";
      } else {
        return fmtRaw(n);
      }
    }

    function fmtPercent(rate) {
      return (rate * 100).toFixed(2);
    }

    let rules = [];
    let ruleIdCounter = 1;

    function getRuleTypeLabel(type) {
      if (type === "flatGift") return "滿額送機器";
      if (type === "stepGift") return "超額每一階送機器";
      if (type === "stepPercent") return "超額每一階現金折扣％";
      return type;
    }

    function addRule(type) {
      const id = ruleIdCounter++;
      let params = {};
      if (type === "flatGift") {
        params = { label: "A 機器", units: 7, valuePerUnit: 10000 };
      } else if (type === "stepGift") {
        params = { label: "B 機器", valuePerUnit: 8000 };
      } else if (type === "stepPercent") {
        params = { label: "每階折扣", percentPerStep: 1 };
      } else {
        return;
      }
      const rule = { id, type, enabled: true, params };
      rules.push(rule);
      createRuleBlock(rule);
      updateAllViews();
    }

    function createRuleBlock(rule) {
      const container = $("rulesContainer");
      const block = document.createElement("div");
      block.className = "rule-block";
      block.id = "rule-block-" + rule.id;

      const header = document.createElement("div");
      header.className = "rule-header";

      const toggleLabel = document.createElement("label");
      toggleLabel.className = "toggle-label";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = rule.enabled;
      checkbox.addEventListener("change", () => {
        rule.enabled = checkbox.checked;
        updateAllViews();
      });
      toggleLabel.appendChild(checkbox);
      const txt = document.createElement("span");
      txt.textContent = "啟用";
      toggleLabel.appendChild(txt);

      const title = document.createElement("span");
      title.className = "rule-title";
      title.textContent = "規則 " + rule.id;

      const typeTag = document.createElement("span");
      typeTag.className = "rule-type-tag";
      typeTag.textContent = getRuleTypeLabel(rule.type);

      const btnDel = document.createElement("button");
      btnDel.className = "btn-delete";
      btnDel.textContent = "刪除";
      btnDel.addEventListener("click", () => {
        rules = rules.filter(r => r.id !== rule.id);
        container.removeChild(block);
        updateAllViews();
      });

      header.appendChild(toggleLabel);
      header.appendChild(title);
      header.appendChild(typeTag);
      header.appendChild(btnDel);

      const body = document.createElement("div");
      body.className = "rule-body";

      if (rule.type === "flatGift") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label><span class="label-main">名稱</span></label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label><span class="label-main">送出台數</span></label>
              <input type="number" data-param="units">
            </div>
            <div>
              <label><span class="label-main">每台價值（元）</span></label>
              <input type="number" data-param="valuePerUnit">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      } else if (rule.type === "stepGift") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label><span class="label-main">名稱</span></label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label><span class="label-main">每階送 1 台之價值（元）</span></label>
              <input type="number" data-param="valuePerUnit">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      } else if (rule.type === "stepPercent") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label><span class="label-main">名稱</span></label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label><span class="label-main">每階現金折扣（％）</span></label>
              <input type="number" data-param="percentPerStep" step="0.1">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      }

      block.appendChild(header);
      block.appendChild(body);
      container.appendChild(block);

      syncRuleInputs(rule);
      attachRuleListeners(rule);
    }

    function syncRuleInputs(rule) {
      const block = $("rule-block-" + rule.id);
      if (!block) return;
      const inputs = block.querySelectorAll("input[data-param]");
      inputs.forEach(input => {
        const param = input.dataset.param;
        const val = rule.params[param];
        if (param === "label") {
          input.value = val || "";
        } else {
          input.value = (val != null) ? val : 0;
        }
      });
    }

    function attachRuleListeners(rule) {
      const block = $("rule-block-" + rule.id);
      if (!block) return;
      const inputs = block.querySelectorAll("input[data-param]");
      inputs.forEach(input => {
        input.addEventListener("input", () => {
          const param = input.dataset.param;
          if (param === "label") {
            rule.params[param] = input.value;
          } else {
            rule.params[param] = Number(input.value) || 0;
          }
          updateAllViews();
        });
      });
    }

    function computeBase() {
      const pricePerUnit = Number($("pricePerUnit").value) || 0;
      const quantity = Number($("quantity").value) || 0;
      const baseDiscountPercent = Number($("baseDiscountPercent").value) || 0;
      const threshold = Number($("threshold").value) || 0;
      const stepAmount = Number($("stepAmount").value) || 1;

      const baseRate = baseDiscountPercent / 100;
      const gross = pricePerUnit * quantity;
      const sales = gross * (1 - baseRate);
      const exceed = Math.max(0, sales - threshold);
      const steps = exceed > 0 ? Math.floor(exceed / stepAmount) : 0;

      return { pricePerUnit, quantity, baseRate, gross, sales, threshold, stepAmount, exceed, steps };
    }

    function updateBasePanel(base) {
      $("base-gross").textContent = fmtAmount(base.gross);
      $("base-rate").textContent = fmtPercent(base.baseRate);
      $("base-sales").textContent = fmtAmount(base.sales);
      $("base-threshold").textContent = fmtAmount(base.threshold);
      $("base-step").textContent = fmtAmount(base.stepAmount);
      $("base-exceed").textContent = fmtAmount(base.exceed);
      $("base-steps").textContent = base.steps.toString();

      const lines = [];
      lines.push("未折扣金額 = 單價 × 數量");
      lines.push(` = ${fmtRaw(base.pricePerUnit)} × ${fmtRaw(base.quantity)} = ${fmtRaw(base.gross)}（≈ ${fmtAmount(base.gross)}）`);
      lines.push("");
      lines.push("折扣後營業額 = 未折扣金額 × (1 - 基本折扣率)");
      lines.push(` = ${fmtRaw(base.gross)} × (1 - ${fmtPercent(base.baseRate)}％) ≈ ${fmtRaw(base.sales)}（≈ ${fmtAmount(base.sales)}）`);
      lines.push("");
      lines.push("超過門檻金額 = max(0, 營業額 - 門檻)");
      lines.push(` = max(0, ${fmtRaw(base.sales)} - ${fmtRaw(base.threshold)}) = ${fmtRaw(base.exceed)}（≈ ${fmtAmount(base.exceed)}）`);
      lines.push("");
      lines.push("階數 = floor(超過門檻金額 ÷ 每階金額)");
      lines.push(` = floor(${fmtRaw(base.exceed)} ÷ ${fmtRaw(base.stepAmount)}) = ${base.steps}`);
      $("base-formula").innerHTML =
        `<div class="title">【基本公式】</div>` + lines.join("\n");
    }

    function computeRule(rule, base) {
      const sales = base.sales;
      const threshold = base.threshold;
      const steps = base.steps;
      const stepAmount = base.stepAmount;

      if (!rule.enabled) {
        return { value: 0, rate: 0, text: "此規則目前未啟用。" };
      }
      if (sales <= 0) {
        return { value: 0, rate: 0, text: "營業額為 0，此規則不生效。" };
      }

      let value = 0;
      const p = rule.params;
      const label = p.label || getRuleTypeLabel(rule.type);
      let text = `名稱：${label}\n`;

      if (rule.type === "flatGift") {
        const units = Number(p.units) || 0;
        const vpu = Number(p.valuePerUnit) || 0;
        if (sales >= threshold) {
          value = units * vpu;
          text += `條件：營業額 ≥ ${fmtRaw(threshold)}（${fmtAmount(threshold)}） → 已達標\n`;
          text += `送出：${units} 台 × ${fmtRaw(vpu)} 元\n`;
          text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
          text += "\n算式：\n";
          text += `折扣金額 = 台數 × 單台價值\n`;
          text += ` = ${units} × ${fmtRaw(vpu)} = ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
          text += `折扣率 = 折扣金額 ÷ 營業額\n`;
          text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
        } else {
          value = 0;
          text += `條件：營業額 ≥ ${fmtRaw(threshold)}（${fmtAmount(threshold)}） → 未達標\n`;
          text += `折扣金額 = 0`;
        }
      } else if (rule.type === "stepGift") {
        const vpu = Number(p.valuePerUnit) || 0;
        value = steps * vpu;
        text += `超過門檻：${fmtRaw(base.exceed)} 元（≈ ${fmtAmount(base.exceed)}），共 ${steps} 階\n`;
        text += `每階送 1 台，單價 ${fmtRaw(vpu)} 元\n`;
        text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
        text += "\n算式：\n";
        text += `折扣金額 = 階數 × 單台價值\n`;
        text += ` = ${steps} × ${fmtRaw(vpu)} = ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
        text += `折扣率 = 折扣金額 ÷ 營業額\n`;
        text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
      } else if (rule.type === "stepPercent") {
        const percent = Number(p.percentPerStep) || 0;
        value = steps * stepAmount * (percent / 100);
        text += `超過門檻：${fmtRaw(base.exceed)} 元（≈ ${fmtAmount(base.exceed)}），共 ${steps} 階\n`;
        text += `每階現折 ${percent}％，每階金額 ${fmtRaw(stepAmount)} 元\n`;
        text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
        text += "\n算式：\n";
        text += `折扣金額 = 階數 × 每階金額 × 每階折扣率\n`;
        text += ` = ${steps} × ${fmtRaw(stepAmount)} × ${percent}％ ≈ ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
        text += `折扣率 = 折扣金額 ÷ 營業額\n`;
        text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
      }

      const rate = sales > 0 ? value / sales : 0;
      return { value, rate, text };
    }

    function updateRulesSummary(base) {
      let totalExtraValue = 0;
      let totalExtraRate = 0;

      rules.forEach(rule => {
        const res = computeRule(rule, base);
        totalExtraValue += res.value;
        totalExtraRate += res.rate;

        const sumEl = $("rule-summary-" + rule.id);
        if (sumEl) sumEl.textContent = res.text;
      });

      $("sum-extra-value").textContent = fmtAmount(totalExtraValue);
      $("sum-extra-rate").textContent = fmtPercent(totalExtraRate);
      $("sum-base-rate").textContent = fmtPercent(base.baseRate);

      const rawTotalRate = base.baseRate + totalExtraRate;
      const totalRate = Math.min(0.9999, Math.max(0, rawTotalRate));
      $("sum-total-rate").textContent = fmtPercent(totalRate);

      const fold = 1 - totalRate;
      $("sum-fold").textContent = (fold > 0 ? (fold * 10).toFixed(2) : "0.00") + " 折";

      const lines = [];
      lines.push("滿額回饋總額 = 各規則折扣金額加總");
      lines.push(` = ${fmtRaw(totalExtraValue)} 元（≈ ${fmtAmount(totalExtraValue)}）`);
      lines.push("");
      lines.push("滿額回饋折扣率 = 滿額回饋總額 ÷ 營業額");
      lines.push(` = ${fmtRaw(totalExtraValue)} ÷ ${fmtRaw(base.sales)} ≈ ${fmtPercent(totalExtraRate)}％`);
      lines.push("");
      lines.push("總折扣率 = 基本折扣率 + 滿額回饋折扣率");
      lines.push(` ≈ ${fmtPercent(base.baseRate)}％ + ${fmtPercent(totalExtraRate)}％ = ${fmtPercent(totalRate)}％`);
      lines.push("");
      lines.push("等效折數 ≈ 1 - 總折扣率");
      lines.push(` ≈ 1 - ${(totalRate).toFixed(4)} = ${(fold).toFixed(4)} → ${(fold > 0 ? (fold*10).toFixed(2) : "0.00")} 折`);
      $("total-formula").innerHTML =
        `<div class="title">【總結算式】</div>` + lines.join("\n");
    }

    function updateAllViews() {
      const base = computeBase();
      updateBasePanel(base);
      updateRulesSummary(base);
    }

    window.addEventListener("DOMContentLoaded", () => {
      ["pricePerUnit","quantity","baseDiscountPercent","threshold","stepAmount"]
        .forEach(id => {
          $(id).addEventListener("input", updateAllViews);
        });

      $("addRuleBtn").addEventListener("click", () => {
        const type = $("newRuleType").value;
        addRule(type);
      });

      // 預設三條規則：對應你原本的 2/3/4 點
      addRule("flatGift");    // 滿額送 A 機器
      addRule("stepGift");    // 超額每階送 B 機器
      addRule("stepPercent"); // 超額每階折 %

      updateAllViews();
    });
  </script>
</body>
</html>
