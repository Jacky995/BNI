<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>成本試算積木計算器 v2</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #050509;
      color: #f5f5f5;
      line-height: 1.5;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 6px 0;
    }
    p {
      margin: 0 0 8px 0;
    }
    .layout {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .panel {
      flex: 1;
      min-width: 320px;
      background: #11111a;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .panel h2 {
      font-size: 16px;
      margin: 0 0 8px 0;
    }
    .panel h3 {
      font-size: 14px;
      margin: 8px 0 4px 0;
    }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .input-row > div {
      flex: 1;
      min-width: 150px;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 6px;
    }
    input, select {
      width: 100%;
      padding: 4px 6px;
      margin-top: 2px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #181820;
      color: #f5f5f5;
      font-size: 13px;
    }
    small {
      font-size: 11px;
      opacity: 0.7;
    }
    hr {
      border: none;
      border-top: 1px solid #272737;
      margin: 10px 0;
    }

    .base-summary, .total-summary {
      font-size: 13px;
      background: #181820;
      border-radius: 8px;
      padding: 8px;
      margin-top: 4px;
    }
    .base-summary div, .total-summary div {
      margin-bottom: 4px;
    }
    .total-summary strong {
      font-size: 14px;
    }

    .formula-block {
      font-size: 11px;
      background: #101018;
      border-radius: 6px;
      padding: 6px 8px;
      margin-top: 6px;
      white-space: pre-line;
      color: #ccccff;
    }

    #rulesContainer {
      margin-top: 8px;
    }
    .rule-block {
      background: #272744;
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      position: relative;
    }
    .rule-block::before {
      content: "";
      position: absolute;
      left: -8px;
      top: 14px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #050509;
      box-shadow: 0 0 0 2px #191926;
    }
    .rule-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .rule-title {
      font-size: 13px;
      font-weight: 600;
      flex: 1;
    }
    .rule-type-tag {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #3949ab;
      opacity: 0.9;
    }
    .btn-delete {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #ff8a65;
      background: transparent;
      color: #ffab91;
      padding: 2px 8px;
      cursor: pointer;
    }
    .btn-delete:hover {
      background: #ff704330;
    }
    .rule-body {
      font-size: 12px;
    }
    .field-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .field-row > div {
      flex: 1;
      min-width: 110px;
    }
    .rule-summary {
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px dashed #444;
      white-space: pre-line;
      font-size: 11px;
      color: #e0e0ff;
    }
    .add-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    .add-row button {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #4caf50;
      background: #43a047;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    .add-row button:hover {
      filter: brightness(1.08);
    }
    .hint {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
    }
    .value {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>成本試算積木計算器 v2</h1>
  <p style="font-size:13px; opacity:0.8;">
    左：基本條件。右：用積木規則疊折扣。<br>
    ‧ 所有金額自動換算成「萬」單位顯示（≥1萬就顯示 x.xxxx(萬)）。<br>
    ‧ 每一塊都列出完整算式，方便你查核。
  </p>

  <div class="layout">
    <!-- 左邊：基本條件 -->
    <div class="panel">
      <h2>1. 基本條件</h2>
      <div class="input-row">
        <div>
          <label>每台經銷價（未折扣，元）</label>
          <input type="number" id="pricePerUnit" value="10000">
        </div>
        <div>
          <label>數量（台）</label>
          <input type="number" id="quantity" value="200">
        </div>
      </div>

      <div class="input-row">
        <div>
          <label>基本折扣（％）<br><small>例：9 = 9% 折扣 → 91 折</small></label>
          <input type="number" id="baseDiscountPercent" value="9" step="0.1">
        </div>
      </div>

      <hr>

      <h3>滿額門檻設定</h3>
      <div class="input-row">
        <div>
          <label>滿額門檻金額（元）</label>
          <input type="number" id="threshold" value="2000000">
        </div>
        <div>
          <label>超過門檻後，每一階金額（元）</label>
          <input type="number" id="stepAmount" value="120000">
        </div>
      </div>

      <div class="base-summary">
        <div>未折扣金額：<span id="base-gross" class="value">0</span></div>
        <div>
          基本折扣：<span id="base-rate" class="value">0</span>％ →
          折扣後營業額：<span id="base-sales" class="value">0</span>
        </div>
        <div>
          門檻：<span id="base-threshold" class="value">0</span>；
          每階：<span id="base-step" class="value">0</span>
        </div>
        <div>
          超過門檻：<span id="base-exceed" class="value">0</span>；
          共 <span id="base-steps" class="value">0</span> 階
        </div>
      </div>

      <div class="formula-block" id="base-formula">
        <!-- 這裡會動態填入完整算式 -->
      </div>

      <p class="hint">
        ※ 顯示單位：數字 ≥ 10,000 會顯示為「x.xxxx(萬)」，否則顯示原數字。
      </p>
    </div>

    <!-- 右邊：規則積木 + 總結 -->
    <div class="panel">
      <h2>2. 規則積木</h2>

      <div id="rulesContainer"></div>

      <div class="add-row">
        <select id="newRuleType">
          <option value="flatGift">滿額送機器（一次性）</option>
          <option value="stepGift">超額每一階送機器</option>
          <option value="stepPercent">超額每一階現金折扣％</option>
        </select>
        <button id="addRuleBtn">新增規則</button>
      </div>

      <p class="hint">
        例：<br>
        ‧ 規則1：滿 200 萬送 A 機器 7 台 → 選「滿額送機器」<br>
        ‧ 規則2：超過 200 萬每 12 萬送 B 機器 1 台 → 選「超額每一階送機器」<br>
        ‧ 規則3：超過 200 萬每 12 萬再折 1% → 選「超額每一階現金折扣％」
      </p>

      <hr>

      <h3>3. 總結（給老闆看）</h3>
      <div class="total-summary">
        <div>
          滿額回饋折掉：
          <span id="sum-extra-value" class="value">0</span>
          （約 <span id="sum-extra-rate" class="value">0</span>％）
        </div>
        <div>基本折扣：<span id="sum-base-rate" class="value">0</span>％</div>
        <div>
          <strong>
            全部加起來 ≒ 折掉
            <span id="sum-total-rate" class="value">0</span>％，
            約 <span id="sum-fold" class="value">0</span> 折
          </strong>
        </div>
      </div>

      <div class="formula-block" id="total-formula">
        <!-- 總結算式 -->
      </div>
    </div>
  </div>

  <script>
    function $(id) { return document.getElementById(id); }

    // 原始數字（加千分位）
    function fmtRaw(n) {
      return n.toLocaleString("zh-TW", { maximumFractionDigits: 0 });
    }

    // 單位轉換：>=1萬 → 顯示成 x.xxxx(萬)
    function fmtAmount(n) {
      const abs = Math.abs(n);
      if (abs >= 10000) {
        const wan = n / 10000;
        let s = wan.toFixed(4);
        s = s.replace(/0+$/,"").replace(/\.$/,"");
        return s + "(萬)";
      } else {
        return fmtRaw(n);
      }
    }

    function fmtPercent(rate) {
      return (rate * 100).toFixed(2);
    }

    let rules = [];
    let ruleIdCounter = 1;

    function getRuleTypeLabel(type) {
      if (type === "flatGift") return "滿額送機器";
      if (type === "stepGift") return "超額每一階送機器";
      if (type === "stepPercent") return "超額每一階現金折扣％";
      return type;
    }

    function addRule(type) {
      const id = ruleIdCounter++;
      let params = {};
      if (type === "flatGift") {
        params = { label: "A 機器", units: 7, valuePerUnit: 10000 };
      } else if (type === "stepGift") {
        params = { label: "B 機器", valuePerUnit: 8000 };
      } else if (type === "stepPercent") {
        params = { label: "每階折扣", percentPerStep: 1 };
      } else {
        return;
      }
      const rule = { id, type, enabled: true, params };
      rules.push(rule);
      createRuleBlock(rule);
      updateAllViews();
    }

    function createRuleBlock(rule) {
      const container = $("rulesContainer");
      const block = document.createElement("div");
      block.className = "rule-block";
      block.id = "rule-block-" + rule.id;

      const header = document.createElement("div");
      header.className = "rule-header";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = rule.enabled;
      checkbox.addEventListener("change", () => {
        rule.enabled = checkbox.checked;
        updateAllViews();
      });

      const enableLabel = document.createElement("span");
      enableLabel.style.fontSize = "11px";
      enableLabel.textContent = "啟用";

      const title = document.createElement("span");
      title.className = "rule-title";
      title.textContent = "規則 " + rule.id + "：";

      const typeTag = document.createElement("span");
      typeTag.className = "rule-type-tag";
      typeTag.textContent = getRuleTypeLabel(rule.type);

      const btnDel = document.createElement("button");
      btnDel.className = "btn-delete";
      btnDel.textContent = "刪除";
      btnDel.addEventListener("click", () => {
        rules = rules.filter(r => r.id !== rule.id);
        container.removeChild(block);
        updateAllViews();
      });

      header.appendChild(checkbox);
      header.appendChild(enableLabel);
      header.appendChild(title);
      header.appendChild(typeTag);
      header.appendChild(btnDel);

      const body = document.createElement("div");
      body.className = "rule-body";

      if (rule.type === "flatGift") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label>名稱（例：A 機器）</label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label>送出台數</label>
              <input type="number" data-param="units">
            </div>
            <div>
              <label>每台價值（元）</label>
              <input type="number" data-param="valuePerUnit">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      } else if (rule.type === "stepGift") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label>名稱（例：B 機器）</label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label>每階送 1 台，單台價值（元）</label>
              <input type="number" data-param="valuePerUnit">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      } else if (rule.type === "stepPercent") {
        body.innerHTML = `
          <div class="field-row">
            <div>
              <label>名稱（例：每階折扣）</label>
              <input type="text" data-param="label">
            </div>
            <div>
              <label>每一階現金折扣（％）</label>
              <input type="number" data-param="percentPerStep" step="0.1">
            </div>
          </div>
          <div class="rule-summary" id="rule-summary-${rule.id}"></div>
        `;
      }

      block.appendChild(header);
      block.appendChild(body);
      container.appendChild(block);

      syncRuleInputs(rule);
      attachRuleListeners(rule);
    }

    function syncRuleInputs(rule) {
      const block = $("rule-block-" + rule.id);
      if (!block) return;
      const inputs = block.querySelectorAll("input[data-param]");
      inputs.forEach(input => {
        const param = input.dataset.param;
        const val = rule.params[param];
        if (param === "label") {
          input.value = val || "";
        } else {
          input.value = (val != null) ? val : 0;
        }
      });
    }

    function attachRuleListeners(rule) {
      const block = $("rule-block-" + rule.id);
      if (!block) return;
      const inputs = block.querySelectorAll("input[data-param]");
      inputs.forEach(input => {
        input.addEventListener("input", () => {
          const param = input.dataset.param;
          if (param === "label") {
            rule.params[param] = input.value;
          } else {
            rule.params[param] = Number(input.value) || 0;
          }
          updateAllViews();
        });
      });
    }

    function computeBase() {
      const pricePerUnit = Number($("pricePerUnit").value) || 0;
      const quantity = Number($("quantity").value) || 0;
      const baseDiscountPercent = Number($("baseDiscountPercent").value) || 0;
      const threshold = Number($("threshold").value) || 0;
      const stepAmount = Number($("stepAmount").value) || 1;

      const baseRate = baseDiscountPercent / 100;
      const gross = pricePerUnit * quantity;
      const sales = gross * (1 - baseRate);
      const exceed = Math.max(0, sales - threshold);
      const steps = exceed > 0 ? Math.floor(exceed / stepAmount) : 0;

      return { pricePerUnit, quantity, baseRate, gross, sales, threshold, stepAmount, exceed, steps };
    }

    function updateBasePanel(base) {
      $("base-gross").textContent = fmtAmount(base.gross);
      $("base-rate").textContent = fmtPercent(base.baseRate);
      $("base-sales").textContent = fmtAmount(base.sales);
      $("base-threshold").textContent = fmtAmount(base.threshold);
      $("base-step").textContent = fmtAmount(base.stepAmount);
      $("base-exceed").textContent = fmtAmount(base.exceed);
      $("base-steps").textContent = base.steps.toString();

      // 完整算式
      const lines = [];
      lines.push("【基本公式】");
      lines.push("未折扣金額 = 單價 × 數量");
      lines.push(` = ${fmtRaw(base.pricePerUnit)} × ${fmtRaw(base.quantity)} = ${fmtRaw(base.gross)}（≈ ${fmtAmount(base.gross)}）`);
      lines.push("");
      lines.push("折扣後營業額 = 未折扣金額 × (1 - 基本折扣率)");
      lines.push(` = ${fmtRaw(base.gross)} × (1 - ${fmtPercent(base.baseRate)}％) ≈ ${fmtRaw(base.sales)}（≈ ${fmtAmount(base.sales)}）`);
      lines.push("");
      lines.push("超過門檻金額 = max(0, 營業額 - 門檻)");
      lines.push(` = max(0, ${fmtRaw(base.sales)} - ${fmtRaw(base.threshold)}) = ${fmtRaw(base.exceed)}（≈ ${fmtAmount(base.exceed)}）`);
      lines.push("");
      lines.push("階數 = floor(超過門檻金額 ÷ 每階金額)");
      lines.push(` = floor(${fmtRaw(base.exceed)} ÷ ${fmtRaw(base.stepAmount)}) = ${base.steps}`);
      $("base-formula").textContent = lines.join("\n");
    }

    function computeRule(rule, base) {
      const sales = base.sales;
      const threshold = base.threshold;
      const steps = base.steps;
      const stepAmount = base.stepAmount;

      if (!rule.enabled) {
        return { value: 0, rate: 0, text: "此規則目前未啟用。" };
      }
      if (sales <= 0) {
        return { value: 0, rate: 0, text: "營業額為 0，此規則不生效。" };
      }

      let value = 0;
      const p = rule.params;
      const label = p.label || getRuleTypeLabel(rule.type);

      let text = `名稱：${label}\n`;

      if (rule.type === "flatGift") {
        const units = Number(p.units) || 0;
        const vpu = Number(p.valuePerUnit) || 0;
        if (sales >= threshold) {
          value = units * vpu;
          text += `條件：營業額 ≥ ${fmtRaw(threshold)}（${fmtAmount(threshold)}） → 已達標\n`;
          text += `送出：${units} 台 × ${fmtRaw(vpu)} 元\n`;
          text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
          text += "\n算式：\n";
          text += `折扣金額 = 台數 × 單台價值\n`;
          text += ` = ${units} × ${fmtRaw(vpu)} = ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
          text += `折扣率 = 折扣金額 ÷ 營業額\n`;
          text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
        } else {
          value = 0;
          text += `條件：營業額 ≥ ${fmtRaw(threshold)}（${fmtAmount(threshold)}） → 未達標\n`;
          text += `折扣金額 = 0`;
        }
      } else if (rule.type === "stepGift") {
        const vpu = Number(p.valuePerUnit) || 0;
        value = steps * vpu;
        text += `超過門檻：${fmtRaw(base.exceed)} 元（≈ ${fmtAmount(base.exceed)}），共 ${steps} 階\n`;
        text += `每階送 1 台，單價 ${fmtRaw(vpu)} 元\n`;
        text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
        text += "\n算式：\n";
        text += `折扣金額 = 階數 × 單台價值\n`;
        text += ` = ${steps} × ${fmtRaw(vpu)} = ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
        text += `折扣率 = 折扣金額 ÷ 營業額\n`;
        text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
      } else if (rule.type === "stepPercent") {
        const percent = Number(p.percentPerStep) || 0;
        value = steps * stepAmount * (percent / 100);
        text += `超過門檻：${fmtRaw(base.exceed)} 元（≈ ${fmtAmount(base.exceed)}），共 ${steps} 階\n`;
        text += `每階現折 ${percent}％，每階金額 ${fmtRaw(stepAmount)} 元\n`;
        text += `折扣金額：約 ${fmtRaw(value)} 元（≈ ${fmtAmount(value)}，約折 ${fmtPercent(value/sales)}％）\n`;
        text += "\n算式：\n";
        text += `折扣金額 = 階數 × 每階金額 × 每階折扣率\n`;
        text += ` = ${steps} × ${fmtRaw(stepAmount)} × ${percent}％ ≈ ${fmtRaw(value)}（≈ ${fmtAmount(value)}）\n`;
        text += `折扣率 = 折扣金額 ÷ 營業額\n`;
        text += ` = ${fmtRaw(value)} ÷ ${fmtRaw(sales)} ≈ ${fmtPercent(value/sales)}％`;
      }

      const rate = sales > 0 ? value / sales : 0;
      return { value, rate, text };
    }

    function updateRulesSummary(base) {
      let totalExtraValue = 0;
      let totalExtraRate = 0;

      rules.forEach(rule => {
        const res = computeRule(rule, base);
        totalExtraValue += res.value;
        totalExtraRate += res.rate;

        const sumEl = $("rule-summary-" + rule.id);
        if (sumEl) sumEl.textContent = res.text;
      });

      $("sum-extra-value").textContent = fmtAmount(totalExtraValue);
      $("sum-extra-rate").textContent = fmtPercent(totalExtraRate);
      $("sum-base-rate").textContent = fmtPercent(base.baseRate);

      const rawTotalRate = base.baseRate + totalExtraRate;
      const totalRate = Math.min(0.9999, Math.max(0, rawTotalRate));
      $("sum-total-rate").textContent = fmtPercent(totalRate);
      $("sum-fold").textContent = (1 - totalRate > 0 ? (1 - totalRate) * 10 : 0).toFixed(2);

      const lines = [];
      lines.push("【總結算式】");
      lines.push("滿額回饋總額 = 各規則折扣金額加總");
      lines.push(` = ${fmtRaw(totalExtraValue)} 元（≈ ${fmtAmount(totalExtraValue)}）`);
      lines.push("");
      lines.push("滿額回饋折扣率 = 滿額回饋總額 ÷ 營業額");
      lines.push(` = ${fmtRaw(totalExtraValue)} ÷ ${fmtRaw(base.sales)} ≈ ${fmtPercent(totalExtraRate)}％`);
      lines.push("");
      lines.push("總折扣率 = 基本折扣率 + 滿額回饋折扣率");
      lines.push(` ≈ ${fmtPercent(base.baseRate)}％ + ${fmtPercent(totalExtraRate)}％ = ${fmtPercent(totalRate)}％`);
      lines.push("");
      lines.push("等效折數 ≈ 1 - 總折扣率");
      lines.push(` ≈ 1 - ${ (totalRate).toFixed(4) } = ${(1-totalRate).toFixed(4)} → ${(1-totalRate)*10>0 ? ((1-totalRate)*10).toFixed(2) : "0.00"} 折`);
      $("total-formula").textContent = lines.join("\n");
    }

    function updateAllViews() {
      const base = computeBase();
      updateBasePanel(base);
      updateRulesSummary(base);
    }

    window.addEventListener("DOMContentLoaded", () => {
      ["pricePerUnit","quantity","baseDiscountPercent","threshold","stepAmount"]
        .forEach(id => {
          $(id).addEventListener("input", updateAllViews);
        });

      $("addRuleBtn").addEventListener("click", () => {
        const type = $("newRuleType").value;
        addRule(type);
      });

      // 預設三條規則：對應你原本說的 2/3/4 點
      addRule("flatGift");    // 滿額送 A 機器
      addRule("stepGift");    // 超額每階送 B 機器
      addRule("stepPercent"); // 超額每階折 %

      updateAllViews();
    });
  </script>
</body>
</html>
